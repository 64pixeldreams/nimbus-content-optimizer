<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="NimbusAI - Content Optimization Platform">
	<meta name="author" content="NimbusAI">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="/assets/img/icons/icon-48x48.png" />

	<title>Analytics - NimbusHQ</title>

	<link href="/assets/css/app.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body>
	<div class="wrapper">
		<!-- Sidebar Navigation -->
		<nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="/app/dashboard.html">
					<span class="align-middle">NimbusHQ</span>
				</a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						Main
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/dashboard.html">
							<i class="align-middle" data-feather="home"></i> <span class="align-middle">Account Home</span>
						</a>
					</li>

					<li class="sidebar-item active">
						<a class="sidebar-link" href="/app/analytics.html">
							<i class="align-middle" data-feather="bar-chart-2"></i> <span class="align-middle">Analytics</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/activity.html">
							<i class="align-middle" data-feather="activity"></i> <span class="align-middle">Activity</span>
						</a>
					</li>

					<li class="sidebar-header">
						Account
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/notifications.html">
							<i class="align-middle" data-feather="bell"></i> <span class="align-middle">Notifications</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/settings.html">
							<i class="align-middle" data-feather="settings"></i> <span class="align-middle">Settings</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/profile.html">
							<i class="align-middle" data-feather="user"></i> <span class="align-middle">Profile</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>

		<!-- Main Content -->
		<div class="main">
			<!-- Top Navigation Bar -->
			<nav class="navbar navbar-expand navbar-light navbar-bg">
				<a class="sidebar-toggle js-sidebar-toggle">
					<i class="hamburger align-self-center"></i>
				</a>

				<div class="navbar-collapse collapse">
					<ul class="navbar-nav navbar-align">
						<!-- Notifications -->
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle" href="#" id="alertsDropdown" data-bs-toggle="dropdown" onclick="refreshNotificationsOnOpen()">
								<div class="position-relative">
									<i class="align-middle" data-feather="bell"></i>
									<span class="indicator" id="notification-count" style="display: none;">0</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0" aria-labelledby="alertsDropdown">
								<div class="dropdown-menu-header" id="notifications-header">
									<div class="spinner-border spinner-border-sm" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
									Loading notifications...
								</div>
								<div class="list-group" id="notifications-list">
									<!-- Notifications will be loaded here -->
								</div>
								<div class="dropdown-menu-footer">
									<a href="/app/notifications.html" class="text-muted">Show all notifications</a>
								</div>
							</div>
						</li>

						<!-- User Menu -->
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
								<i class="align-middle" data-feather="settings"></i>
							</a>

							<a class="nav-link d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
								<div class="d-flex align-items-center">
									<div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; flex-shrink: 0;">
										<i data-feather="user" style="width: 16px; height: 16px;"></i>
									</div>
									<span class="text-dark dropdown-toggle" id="user-name">Loading...</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-end" style="min-width: 250px;">
								<a class="dropdown-item" href="/app/profile.html"><i class="align-middle me-1" data-feather="user"></i> Profile</a>
								<a class="dropdown-item" href="/app/settings.html"><i class="align-middle me-1" data-feather="settings"></i> Settings</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#" onclick="handleLogout()"><i class="align-middle me-1" data-feather="log-out"></i> Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

			<!-- Page Content -->
			<main class="content">
				<div class="container-fluid p-0">
					<!-- Page Header -->
					<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
						<div>
							<div style="font-size: 16px; line-height: 1.5; color: black; font-weight: 600; margin-bottom: 8px;">Analytics</div>
							<h1 class="h2" id="account-title">Loading...</h1>
						</div>
					</div>

					<!-- Stats Row (Same as dashboard) -->
					<div class="row mb-4">
						<div class="col-md-4">
							<div class="card">
								<div class="card-body">
									<div class="row">
										<div class="col mt-0">
											<h5 class="card-title">Projects</h5>
										</div>
										<div class="col-auto">
											<div class="stat text-primary">
												<i class="align-middle" data-feather="folder"></i>
											</div>
										</div>
									</div>
									<h1 class="mt-1 mb-3" id="projects-count">-</h1>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card">
								<div class="card-body">
									<div class="row">
										<div class="col mt-0">
											<h5 class="card-title">Pages</h5>
										</div>
										<div class="col-auto">
											<div class="stat text-success">
												<i class="align-middle" data-feather="file-text"></i>
											</div>
										</div>
									</div>
									<h1 class="mt-1 mb-3" id="pages-count">-</h1>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card">
								<div class="card-body">
									<div class="row">
										<div class="col mt-0">
											<h5 class="card-title">Processing</h5>
										</div>
										<div class="col-auto">
											<div class="stat text-warning">
												<i class="align-middle" data-feather="clock"></i>
											</div>
										</div>
									</div>
									<h1 class="mt-1 mb-3" id="processing-count">-</h1>
								</div>
							</div>
						</div>
					</div>

					<!-- User Analytics/Logs Table (AIVERIE Style) -->
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header d-flex justify-content-between align-items-center">
									<h5 class="card-title mb-0">User Analytics & Logs</h5>
									<a href="#" onclick="reloadAnalytics(); return false;" class="text-muted text-decoration-none" style="font-size: 14px;">
										<i data-feather="refresh-cw" style="width: 14px; height: 14px;"></i> Reload
									</a>
								</div>
								<div class="card-body">
									<div id="analytics-container">
										<div class="loading text-center py-4">
											<div class="spinner-border text-primary"></div>
											<p class="mt-2">Loading analytics...</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- AdminKit Core JS -->
	<script src="/assets/js/adminkit.js"></script>
	
	<!-- Your Custom Framework -->
	<script src="/assets/js/cframework.js"></script>
	<script src="/assets/js/nimbus.js"></script>

	<script>
		// Initialize CFramework and load analytics
		document.addEventListener('DOMContentLoaded', async function() {
			console.log('üîç ANALYTICS PAGE: Script starting...');
			
			// Initialize CFramework with config
			cf.init({
				serverUrl: 'https://nimbus-platform.martin-598.workers.dev',
				appName: 'nimbus'
			});
			
			// Check authentication
			if (!cf.isAuthenticated()) {
				console.log('‚ùå ANALYTICS PAGE: Not authenticated, redirecting to login');
				window.location.href = '/login.html';
				return;
			}
			
			console.log('‚úÖ ANALYTICS PAGE: Authenticated, loading analytics');
			
			// Update user display
			const user = cf.getUser();
			if (user) {
				document.getElementById('user-name').textContent = cf.getUserName();
				document.getElementById('account-title').textContent = `${user.email}'s analytics:`;
			}
			
			// Load dashboard stats (same as dashboard)
			await loadDashboardStats();
			
			// Load user analytics/logs
			await loadAnalytics();
			await loadNotifications();
		});

		async function loadDashboardStats() {
			try {
				console.log('üìä Loading dashboard stats...');
				
				// Use the same nimbus.loadDashboard() method as the main dashboard
				const data = await nimbus.loadDashboard();
				
				// Update display with the same stats calculation
				document.getElementById('projects-count').textContent = data.stats.projectCount;
				document.getElementById('pages-count').textContent = data.stats.pageCount;
				document.getElementById('processing-count').textContent = data.stats.processingCount;
				
				console.log('‚úÖ Dashboard stats loaded:', data.stats);
			} catch (error) {
				console.error('‚ùå Failed to load dashboard stats:', error);
			}
		}

		async function loadAnalytics() {
			try {
				console.log('üìà Loading user analytics...');
				
				// Get user logs for analytics using nimbus wrapper
				const logs = await nimbus.logs.user(100);
				
				console.log('‚úÖ Analytics loaded:', logs.length, 'logs');
				renderAnalytics(logs);
			} catch (error) {
				console.error('‚ùå Analytics loading failed:', error);
				renderAnalyticsError();
			}
		}

		function renderAnalytics(logs) {
			const container = document.getElementById('analytics-container');
			
			if (logs.length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<h5>No analytics data yet</h5>
						<p class="text-muted">Analytics data will appear here as you use the platform</p>
					</div>
				`;
				return;
			}
			
			const tableRows = logs.map(log => {
				// Format time in AIVERIE style (HH:MM:SS)
				const time = new Date(log.timestamp || log.created_at);
				const timeStr = time.toLocaleTimeString('en-GB', { 
					hour12: false, 
					hour: '2-digit', 
					minute: '2-digit', 
					second: '2-digit' 
				});
				
				// Truncate user ID like AIVERIE
				const userId = log.user_id || '-';
				const truncatedUserId = userId.length > 15 ? 
					`${userId.substring(0, 8)}...${userId.substring(userId.length - 6)}` : 
					userId;
				
				// Format duration if available
				const duration = log.duration_ms ? 
					`${(log.duration_ms / 1000).toFixed(1)}s` : 
					'';
				
				// Make entity ID clickable based on type
				const entityId = log.entity_id || '-';
				let entityLink = entityId;
				
				if (entityId.startsWith('page:')) {
					entityLink = `<a href="/app/page.html#${entityId}" class="text-decoration-none text-primary">${entityId}</a>`;
				} else if (entityId.startsWith('project:')) {
					entityLink = `<a href="/app/project.html#${entityId}" class="text-decoration-none text-primary">${entityId}</a>`;
				}
				
				// Clean action display
				const actionDisplay = formatActionDisplay(log.action);
				
				return `
					<tr class="log-row" data-log-id="${log.log_id || log.id}" style="cursor: pointer;">
						<td style="font-family: monospace; font-size: 0.9em; color: #6c757d;">${timeStr}</td>
						<td style="font-family: monospace; font-size: 0.9em; color: #6c757d;">${truncatedUserId}</td>
						<td>${actionDisplay}</td>
						<td style="font-family: monospace; font-size: 0.9em; color: #6c757d;">${duration}</td>
						<td>${entityLink}</td>
					</tr>
					<tr class="log-details" data-log-id="${log.log_id || log.id}" style="display: none;">
						<td colspan="5" style="padding: 0; border-top: none;">
							<div class="log-details-content" style="padding: 12px; background-color: #f8f9fa; border-left: 3px solid #007bff;">
								<div class="row">
									<div class="col-md-6">
										<h6 style="margin-bottom: 8px; font-size: 0.9em; color: #495057;">Basic Information</h6>
										<table class="table table-sm table-borderless mb-0" style="font-size: 0.8em;">
											<tr><td style="width: 100px; color: #6c757d;"><strong>Message:</strong></td><td>${log.message || '-'}</td></tr>
											<tr><td style="color: #6c757d;"><strong>User:</strong></td><td style="font-family: monospace;">${log.user_id}</td></tr>
											${log.duration_ms ? `<tr><td style="color: #6c757d;"><strong>Duration:</strong></td><td>${(log.duration_ms / 1000).toFixed(1)}s</td></tr>` : ''}
										</table>
									</div>
									<div class="col-md-6">
										<h6 style="margin-bottom: 8px; font-size: 0.9em; color: #495057;">Technical Details</h6>
										<table class="table table-sm table-borderless mb-0" style="font-size: 0.8em;">
											<tr><td style="width: 100px; color: #6c757d;"><strong>Action:</strong></td><td style="font-family: monospace;">${log.action}</td></tr>
											<tr><td style="color: #6c757d;"><strong>Entity:</strong></td><td style="font-family: monospace;">${log.entity_type}:${log.entity_id}</td></tr>
											<tr><td style="color: #6c757d;"><strong>Level:</strong></td><td><span class="badge bg-${getLogLevelColor(log.level)}">${log.level}</span></td></tr>
										</table>
									</div>
								</div>
								${log.details && Object.keys(log.details).length > 0 ? `
									<div class="mt-2">
										<h6 style="margin-bottom: 6px; font-size: 0.9em; color: #495057;">Additional Details</h6>
										<pre class="mb-0" style="font-size: 0.75em; background-color: #e9ecef; padding: 8px; border-radius: 4px; max-height: 150px; overflow-y: auto;">${JSON.stringify(log.details, null, 2)}</pre>
									</div>
								` : ''}
							</div>
						</td>
					</tr>
				`;
			}).join('');
			
			container.innerHTML = `
				<div class="table-responsive">
					<table class="table table-sm table-hover">
						<thead class="table-light">
							<tr>
								<th style="width: 80px;">Time</th>
								<th style="width: 120px;">User</th>
								<th>Action</th>
								<th style="width: 80px;">Duration</th>
								<th>Entity</th>
							</tr>
						</thead>
						<tbody>
							${tableRows}
						</tbody>
					</table>
				</div>
			`;
			
			// Add click handlers for log details
			addLogClickHandlers(logs);
		}

		function renderAnalyticsError() {
			const container = document.getElementById('analytics-container');
			container.innerHTML = `
				<div class="text-center py-4">
					<h5>Failed to load analytics</h5>
					<p class="text-muted">Please try refreshing the page</p>
					<button class="btn btn-primary" onclick="loadAnalytics()">Retry</button>
				</div>
			`;
		}

		function formatActionDisplay(action) {
			const actionMap = {
				'page_created': 'Page Created',
				'page_updated': 'Page Updated',
				'page_status_updated': 'Status Updated',
				'page_processing_started': 'Processing Started',
				'page_processing_completed': 'Processing Completed',
				'page_processing_failed': 'Processing Failed',
				'page_upload_started': 'Upload Started',
				'page_upload_completed': 'Upload Completed',
				'page_upload_failed': 'Upload Failed',
				'project_created': 'Project Created',
				'project_updated': 'Project Updated',
				'user_login': 'User Login',
				'user_logout': 'User Logout',
				'summary_generation_started': 'Summary Generation Started',
				'summary_generation_completed': 'Summary Generation Completed',
				'summary_generation_failed': 'Summary Generation Failed'
			};
			
			return actionMap[action] || action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
		}
		
		function addLogClickHandlers(logs) {
			// Add click handlers for expandable row details
			document.querySelectorAll('.log-row').forEach(row => {
				row.addEventListener('click', function() {
					const logId = this.dataset.logId;
					toggleLogDetails(logId);
				});
			});
		}
		
		function toggleLogDetails(logId) {
			// Find the details row for this log
			const detailsRow = document.querySelector(`tr.log-details[data-log-id="${logId}"]`);
			if (!detailsRow) return;
			
			// Toggle visibility
			if (detailsRow.style.display === 'none') {
				detailsRow.style.display = '';
				// Add smooth animation
				detailsRow.style.opacity = '0';
				detailsRow.style.transition = 'opacity 0.2s ease-in-out';
				setTimeout(() => {
					detailsRow.style.opacity = '1';
				}, 10);
			} else {
				// Smooth fade out
				detailsRow.style.opacity = '0';
				detailsRow.style.transition = 'opacity 0.2s ease-in-out';
				setTimeout(() => {
					detailsRow.style.display = 'none';
				}, 200);
			}
		}
		
		function getLogLevelColor(level) {
			const colors = {
				'info': 'primary',
				'warn': 'warning',
				'error': 'danger',
				'success': 'success'
			};
			return colors[level] || 'secondary';
		}

		async function reloadAnalytics() {
			// Show loading state
			document.getElementById('analytics-container').innerHTML = `
				<div class="loading text-center py-4">
					<div class="spinner-border text-primary"></div>
					<p class="mt-2">Reloading analytics...</p>
				</div>
			`;
			
			// Reload both stats and analytics
			await loadDashboardStats();
			await loadAnalytics();
			await loadNotifications();
		}

		// Logout function
		async function handleLogout() {
			await cf.logout();
			window.location.href = '/login.html';
		}

		// Smart Notification functions with caching (EXACT copy from dashboard.js)
		async function loadNotifications(forceRefresh = false) {
			console.log(`üîî Loading notifications...`);
			
			// Use centralized CFramework method
			const result = await cf.loadAndRenderNotifications(forceRefresh);
			
			if (result.success) {
				console.log(`‚úÖ Notifications loaded: ${result.notifications.length}`);
				
				// Update header with count info
				const header = document.getElementById('notifications-header');
				const unseenCount = result.notifications.filter(n => !n.seen).length;
				const totalCount = result.notifications.length;
				
				if (unseenCount > 0) {
					header.innerHTML = `${unseenCount} New Notification${unseenCount === 1 ? '' : 's'} (${totalCount} total)`;
				} else {
					header.innerHTML = `No new notifications (${totalCount} total)`;
				}
			} else {
				console.error('‚ùå Failed to load notifications:', result.error);
			}
		}

		function renderNotifications(notifications) {
			const container = document.getElementById('notifications-list');
			
			if (notifications.length === 0) {
				container.innerHTML = `
					<div class="list-group-item text-center py-3">
						<div class="text-muted">No notifications yet</div>
						<small class="text-muted">You'll see updates here when things happen</small>
					</div>
				`;
				return;
			}

			container.innerHTML = notifications.map(notification => {
				const timeAgo = formatTimeAgo(notification.created_at);
				const iconClass = getNotificationIcon(notification.type);
				const isUnread = !notification.seen;
				
				return `
					<div class="list-group-item ${isUnread ? 'bg-light' : ''}" style="cursor: pointer;" onclick="markNotificationSeen('${notification.notification_id}')">
						<div class="row g-0 align-items-center">
							<div class="col-2">
								<i class="${iconClass}" data-feather="bell"></i>
							</div>
							<div class="col-10">
								<div class="text-dark fw-bold">${notification.title || 'Notification'}</div>
								<div class="text-muted small mt-1">${notification.message}</div>
								<div class="text-muted small">${timeAgo}</div>
							</div>
						</div>
					</div>
				`;
			}).join('');

			// Re-initialize feather icons
			if (typeof feather !== 'undefined') {
				feather.replace();
			}
		}

		function showNotificationError() {
			const header = document.getElementById('notifications-header');
			const container = document.getElementById('notifications-list');
			
			header.innerHTML = 'Error loading notifications';
			container.innerHTML = `
				<div class="list-group-item text-center py-3">
					<div class="text-danger">Failed to load notifications</div>
					<small class="text-muted">Please try refreshing the page</small>
				</div>
			`;
		}

		async function markNotificationSeen(notificationId) {
			try {
				console.log('üîî Marking notification as seen:', notificationId);
				
				// Mark as seen using smart CFramework (auto-updates cache)
				await cf.markNotificationSeen(notificationId);
				
				// Reload notifications to update the UI (will use updated cache)
				await loadNotifications();
				
				console.log('‚úÖ Notification marked as seen and UI updated');
			} catch (error) {
				console.error('‚ùå Error marking notification as seen:', error);
			}
		}

		async function refreshNotificationsOnOpen() {
			// Only refresh if it's been more than 30 seconds since last check
			const timeSinceLastCheck = Date.now() - (cf._notificationCache?.lastFetch || 0);
			const shouldRefresh = timeSinceLastCheck > 30000; // 30 seconds
			
			if (shouldRefresh) {
				console.log('üîÑ Refreshing notifications on dropdown open');
				await loadNotifications(true); // Force refresh
			} else {
				console.log('üîî Using cached notifications (recent)');
			}
		}

		function updateNotificationCount(notifications) {
			const countElement = document.getElementById('notification-count');
			const unreadCount = notifications.filter(n => !n.seen).length;
			
			if (unreadCount > 0) {
				countElement.textContent = unreadCount;
				countElement.style.display = 'block';
			} else {
				countElement.style.display = 'none';
			}
		}

		function formatTimeAgo(timestamp) {
			const now = new Date();
			const time = new Date(timestamp);
			const diffMs = now - time;
			const diffMins = Math.floor(diffMs / 60000);
			const diffHours = Math.floor(diffMs / 3600000);
			const diffDays = Math.floor(diffMs / 86400000);

			if (diffMins < 1) return 'Just now';
			if (diffMins < 60) return `${diffMins}m ago`;
			if (diffHours < 24) return `${diffHours}h ago`;
			return `${diffDays}d ago`;
		}

		function getNotificationIcon(type) {
			const icons = {
				success: 'text-success',
				error: 'text-danger',
				warning: 'text-warning',
				info: 'text-info'
			};
			return icons[type] || 'text-primary';
		}
	</script>

</body>
</html>
