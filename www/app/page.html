<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="NimbusAI - Content Optimization Platform">
	<meta name="author" content="NimbusAI">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="/assets/img/icons/icon-48x48.png" />

	<title>Page View - NimbusHQ</title>

	<link href="/assets/css/app.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
	
	<!-- Bootstrap 5 Breadcrumb Styles -->
	<style>
		.breadcrumb {
			display: flex;
			flex-wrap: wrap;
			padding: 0;
			margin-bottom: 1rem;
			list-style: none;
		}
		
		.breadcrumb-item {
			display: flex;
		}
		
		.breadcrumb-item + .breadcrumb-item {
			padding-left: 0.5rem;
		}
		
		.breadcrumb-item + .breadcrumb-item::before {
			display: inline-block;
			padding-right: 0.5rem;
			color: #6c757d;
			content: "/";
		}
		
		.breadcrumb-item > a {
			color: #0d6efd;
			text-decoration: none;
		}
		
		.breadcrumb-item > a:hover {
			color: #0a58ca;
			text-decoration: underline;
		}
		
		.breadcrumb-item.active {
			color: #6c757d;
		}
	</style>
</head>

<body>
	<div class="wrapper">
		<!-- Sidebar Navigation -->
		<nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="/app/dashboard.html">
					<span class="align-middle">NimbusHQ</span>
				</a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						Main
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/dashboard.html">
							<i class="align-middle" data-feather="home"></i> <span class="align-middle">Account Home</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="#" onclick="goBackToProject()">
							<i class="align-middle" data-feather="folder"></i> <span class="align-middle" id="sidebar-project-name">Project</span>
						</a>
					</li>

					<li class="sidebar-item active">
						<a class="sidebar-link" href="#">
							<i class="align-middle" data-feather="file-text"></i> <span class="align-middle" id="sidebar-page-name">Page</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/analytics.html">
							<i class="align-middle" data-feather="bar-chart-2"></i> <span class="align-middle">Analytics</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/activity.html">
							<i class="align-middle" data-feather="activity"></i> <span class="align-middle">Activity</span>
						</a>
					</li>

					<li class="sidebar-header">
						Account
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/notifications.html">
							<i class="align-middle" data-feather="bell"></i> <span class="align-middle">Notifications</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/settings.html">
							<i class="align-middle" data-feather="settings"></i> <span class="align-middle">Settings</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/profile.html">
							<i class="align-middle" data-feather="user"></i> <span class="align-middle">Profile</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>

		<!-- Main Content -->
		<div class="main">
			<!-- Top Navigation Bar -->
			<nav class="navbar navbar-expand navbar-light navbar-bg">
				<a class="sidebar-toggle js-sidebar-toggle">
					<i class="hamburger align-self-center"></i>
				</a>

				<div class="navbar-collapse collapse">
					<ul class="navbar-nav navbar-align">
						<!-- Notifications -->
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle" href="#" id="alertsDropdown" data-bs-toggle="dropdown" onclick="refreshNotificationsOnOpen()">
								<div class="position-relative">
									<i class="align-middle" data-feather="bell"></i>
									<span class="indicator" id="notification-count" style="display: none;">0</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0" aria-labelledby="alertsDropdown">
								<div class="dropdown-menu-header" id="notifications-header">
									<div class="spinner-border spinner-border-sm" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
									Loading notifications...
								</div>
								<div class="list-group" id="notifications-list">
									<!-- Notifications will be loaded here -->
								</div>
								<div class="dropdown-menu-footer">
									<a href="/app/notifications.html" class="text-muted">Show all notifications</a>
								</div>
							</div>
						</li>

						<!-- User Menu -->
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
								<i class="align-middle" data-feather="settings"></i>
							</a>

							<a class="nav-link d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
								<div class="d-flex align-items-center">
									<div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; flex-shrink: 0;">
										<i data-feather="user" style="width: 16px; height: 16px;"></i>
									</div>
									<span class="text-dark dropdown-toggle" id="user-name">Loading...</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-end" style="min-width: 250px;">
								<a class="dropdown-item" href="/app/profile.html"><i class="align-middle me-1" data-feather="user"></i> Profile</a>
								<a class="dropdown-item" href="/app/settings.html"><i class="align-middle me-1" data-feather="settings"></i> Settings</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#" onclick="handleLogout()"><i class="align-middle me-1" data-feather="log-out"></i> Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

			<!-- Page Content -->
			<main class="content">
				<div class="container-fluid p-0">
					<!-- Breadcrumb Navigation -->
					<nav aria-label="breadcrumb" class="pt-3 pb-2">
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item"><a href="/app/dashboard.html">Account Home</a></li>
							<li class="breadcrumb-item"><a href="#" id="project-breadcrumb-link">Project</a></li>
							<li class="breadcrumb-item active" aria-current="page">Page</li>
						</ol>
					</nav>

					<!-- Page Header -->
					<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-2 mb-3">
						<div>
							<div style="font-size: 14px; line-height: 1.5; margin-bottom: 8px; color: #6c757d; display: flex; align-items: center;">
								<i id="page-type-icon" data-feather="file" style="width: 16px; height: 16px; margin-right: 8px;"></i>
								<span id="page-type-text" style="font-weight: 600;">Loading...</span>
							</div>
							<h1 class="h2 fw-bold mb-1" id="page-title" style="color: #212529;">Loading...</h1>
							<div class="small" id="page-url-header" style="color: #0066cc; font-size: 13px;">Loading...</div>
						</div>
						<div class="btn-toolbar mb-2 mb-md-0">
							<button type="button" class="btn btn-primary" onclick="viewLive()" id="view-live-btn">
								<i data-feather="external-link"></i> View Live Version
							</button>
						</div>
					</div>

					<!-- Enhanced Page View with Tabs -->
					<div class="row">
						<div class="col-12">
							<div class="card border-0 shadow-sm">
								
								<!-- Tab Navigation -->
								<div class="card-header bg-white border-bottom">
									<ul class="nav nav-tabs card-header-tabs" role="tablist">
										<li class="nav-item" role="presentation">
											<a class="nav-link active" data-bs-toggle="tab" href="#overview" role="tab">
												<i class="align-middle me-1" data-feather="home"></i> Overview
											</a>
										</li>
										<li class="nav-item" role="presentation">
											<a class="nav-link" data-bs-toggle="tab" href="#metadata" role="tab">
												<i class="align-middle me-1" data-feather="tag"></i> Metadata
											</a>
										</li>
										<li class="nav-item" role="presentation">
											<a class="nav-link" data-bs-toggle="tab" href="#content" role="tab">
												<i class="align-middle me-1" data-feather="file-text"></i> Content
											</a>
										</li>
										<li class="nav-item" role="presentation">
											<a class="nav-link" data-bs-toggle="tab" href="#seo" role="tab">
												<i class="align-middle me-1" data-feather="search"></i> SEO
											</a>
										</li>
										<li class="nav-item" role="presentation">
											<a class="nav-link" data-bs-toggle="tab" href="#actions" role="tab">
												<i class="align-middle me-1" data-feather="zap"></i> Actions
											</a>
										</li>
										<li class="nav-item" role="presentation">
											<a class="nav-link" data-bs-toggle="tab" href="#json" role="tab">
												<i class="align-middle me-1" data-feather="code"></i> JSON
											</a>
										</li>
									</ul>
								</div>
								
								<!-- Tab Content -->
								<div class="card-body">
									<div class="tab-content">
										
										<!-- Overview Tab -->
										<div class="tab-pane fade show active" id="overview" role="tabpanel">
											
											<!-- SERP Preview -->
											<div class="row mb-4">
												<div class="col-12">
													<div class="card border-0" style="background: #f8f9fa; border: 1px solid #dee2e6 !important;">
														<div class="card-body">
															<div class="small text-muted mb-3">
																<i class="align-middle me-1" data-feather="search" style="width: 14px; height: 14px;"></i>
																Search Engine Preview
															</div>
															<div class="d-flex">
																<!-- Left side - SERP content (Google style) -->
																<div class="flex-grow-1 me-3">
																	<div class="d-flex align-items-center mb-1">
																		<div class="bg-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 16px; height: 16px;">
																			<i class="align-middle text-muted" data-feather="globe" style="width: 10px; height: 10px;"></i>
																		</div>
																		<span class="small text-muted">Repairs By Post</span>
																	</div>
																	<div class="text-success small mb-1" id="serp-url" style="font-family: arial, sans-serif; font-size: 14px;">Loading...</div>
																	<h6 class="mb-1" id="serp-title" style="color: #1a0dab; font-family: arial, sans-serif; font-size: 20px; line-height: 1.3; font-weight: 400;">Loading...</h6>
																	<p class="text-muted mb-2 small" id="serp-description" style="font-family: arial, sans-serif; color: #4d5156; line-height: 1.58; font-size: 14px;">Loading...</p>
																	<div class="small text-muted d-flex align-items-center" id="serp-meta" style="font-size: 12px;">
																		<i class="align-middle me-1" data-feather="clock" style="width: 12px; height: 12px;"></i>
																		<span id="serp-status">Extracted</span> â€¢ <span id="serp-blocks">- blocks</span> â€¢ Ready for AI
																	</div>
																</div>
																<!-- Right side - Header image (Google SERP style) -->
																<div class="flex-shrink-0 ms-3" id="serp-image-container" style="display: none;">
																	<img id="serp-image" style="width: 140px; height: 105px; object-fit: cover; border-radius: 8px; border: 1px solid #dadce0;" alt="Page preview">
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
											
											<!-- Quick Stats -->
											<div class="row mb-4">
												<div class="col-md-3 mb-3">
													<div class="card text-center border-0 h-100" style="background: #fff; border: 1px solid #dee2e6 !important;">
														<div class="card-body py-4">
															<i class="align-middle text-primary mb-3" data-feather="file-text" style="width: 28px; height: 28px;"></i>
															<h4 class="mb-1 fw-bold text-dark" id="total-blocks">-</h4>
															<p class="text-muted mb-0 small fw-medium">Content Blocks</p>
														</div>
													</div>
												</div>
												<div class="col-md-3 mb-3">
													<div class="card text-center border-0 h-100" style="background: #fff; border: 1px solid #dee2e6 !important;">
														<div class="card-body py-4">
															<i class="align-middle text-warning mb-3" data-feather="star" style="width: 28px; height: 28px;"></i>
															<h4 class="mb-1 fw-bold text-dark" id="above-fold-blocks">-</h4>
															<p class="text-muted mb-0 small fw-medium">Above-fold</p>
														</div>
													</div>
												</div>
												<div class="col-md-3 mb-3">
													<div class="card text-center border-0 h-100" style="background: #fff; border: 1px solid #dee2e6 !important;">
														<div class="card-body py-4">
															<i class="align-middle text-success mb-3" data-feather="mouse-pointer" style="width: 28px; height: 28px;"></i>
															<h4 class="mb-1 fw-bold text-dark" id="cta-count">-</h4>
															<p class="text-muted mb-0 small fw-medium">CTAs Found</p>
														</div>
													</div>
												</div>
												<div class="col-md-3 mb-3">
													<div class="card text-center border-0 h-100" style="background: #fff; border: 1px solid #dee2e6 !important;">
														<div class="card-body py-4">
															<i class="align-middle text-info mb-3" data-feather="cpu" style="width: 28px; height: 28px;"></i>
															<h4 class="mb-2 fw-bold text-dark" id="page-priority">Loading...</h4>
															<small class="text-muted" id="page-type-small">Loading...</small>
														</div>
													</div>
												</div>
											</div>
											
											<!-- Page Details -->
											<div class="row">
												<div class="col-md-3 mb-3">
													<div class="p-3 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
														<h6 class="text-muted text-uppercase small mb-2 fw-bold">Status</h6>
														<h5 class="mb-0 fw-bold text-dark" id="page-status">-</h5>
													</div>
												</div>
												<div class="col-md-3 mb-3">
													<div class="p-3 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
														<h6 class="text-muted text-uppercase small mb-2 fw-bold">Created</h6>
														<h5 class="mb-0 fw-bold text-dark" id="page-created">-</h5>
													</div>
												</div>
												<div class="col-md-3 mb-3">
													<div class="p-3 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6;">
														<h6 class="text-muted text-uppercase small mb-2 fw-bold">Updated</h6>
														<h5 class="mb-0 fw-bold text-dark" id="page-updated">-</h5>
													</div>
												</div>
												<div class="col-md-3 mb-3">
													<div class="p-3 rounded" style="background: #f8f9fa; border: 1px solid #dee2e6; cursor: pointer;" onclick="viewLive()" title="Click to view live page">
														<h6 class="text-muted text-uppercase small mb-2 fw-bold">URL</h6>
														<h5 class="mb-0 fw-bold text-primary" id="page-url" style="text-decoration: underline;">-</h5>
													</div>
												</div>
											</div>
											
										</div>
								
								<!-- Metadata Tab -->
								<div class="tab-pane fade" id="metadata" role="tabpanel">
									
									<!-- Metadata Blocks -->
									<div class="row mb-4">
										<div class="col-12">
											<div class="card border-0" style="background: #f8f9fa;">
												<div class="card-header bg-transparent border-0 pb-0">
													<h6 class="mb-0 fw-bold text-dark">
														<i class="align-middle text-primary me-2" data-feather="tag"></i>
														Page Metadata
													</h6>
												</div>
												<div class="card-body">
													<div class="p-4 rounded border" style="background: #ffffff;" id="metadata-preview">
														<div class="text-center py-4">
															<div class="spinner-border text-primary" role="status">
																<span class="visually-hidden">Loading...</span>
															</div>
															<p class="text-muted mt-2 mb-0">Loading metadata...</p>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									
								</div>
								
								<!-- Content Tab -->
								<div class="tab-pane fade" id="content" role="tabpanel">
									
									<!-- Above-fold Preview -->
									<div class="row mb-4">
										<div class="col-12">
											<div class="card border-0" style="border: 1px solid #dee2e6 !important;">
												<div class="card-header bg-white border-bottom">
													<div class="d-flex justify-content-between align-items-center">
														<h6 class="card-title mb-0 fw-bold">
															<i class="align-middle text-warning me-2" data-feather="star"></i>
															Above-fold Content <span id="above-fold-count" class="text-muted small">(0)</span>
														</h6>
														<div class="d-flex align-items-center">
															<div class="input-group input-group-sm" style="width: 200px;">
																<span class="input-group-text">
																	<i data-feather="search" class="text-muted" style="width: 14px; height: 14px;"></i>
																</span>
																<input type="search" class="form-control" id="above-fold-search" placeholder="Search above-fold...">
															</div>
														</div>
													</div>
												</div>
												<div class="card-body">
													<div class="p-4 rounded border" style="background: #f8f9fa;" id="above-fold-preview">
														<div class="text-center py-4">
															<div class="spinner-border text-primary" role="status">
																<span class="visually-hidden">Loading...</span>
															</div>
															<p class="text-muted mt-2 mb-0">Loading above-fold content...</p>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									
									<!-- Content Blocks Table -->
									<div class="row">
										<div class="col-12">
											<div class="card border-0" style="border: 1px solid #dee2e6 !important;">
												<div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center flex-wrap">
													<h6 class="card-title mb-0 fw-bold">
														<i class="align-middle text-primary me-2" data-feather="file-text"></i>
														Content Blocks <span id="content-blocks-count" class="text-muted small">(0)</span>
													</h6>
													<div class="d-flex gap-2 mt-2 mt-md-0">
														<div class="input-group input-group-sm" style="width: auto;">
															<span class="input-group-text">
																<i data-feather="filter" class="text-muted" style="width: 14px; height: 14px;"></i>
															</span>
															<select class="form-select" id="block-filter" style="width: 120px;">
																<option value="">All Types</option>
																<option value="h1">Headlines</option>
																<option value="h2">Subheadings</option>
																<option value="p">Paragraphs</option>
																<option value="a">Links</option>
																<option value="button">Buttons</option>
															</select>
														</div>
														<div class="input-group input-group-sm" style="width: 200px;">
															<span class="input-group-text">
																<i data-feather="search" class="text-muted" style="width: 14px; height: 14px;"></i>
															</span>
															<input type="search" class="form-control" id="block-search" placeholder="Search blocks...">
														</div>
													</div>
												</div>
												<div class="card-body p-0">
													<div class="table-responsive">
														<table class="table table-hover mb-0">
															<thead style="background: #f8f9fa;">
																<tr>
																	<th class="border-0 text-muted small text-uppercase fw-bold py-3">Block ID</th>
																	<th class="border-0 text-muted small text-uppercase fw-bold">Type</th>
																	<th class="border-0 text-muted small text-uppercase fw-bold">Content</th>
																	<th class="border-0 text-muted small text-uppercase fw-bold">Priority</th>
																</tr>
															</thead>
															<tbody id="content-blocks-table">
																<tr>
																	<td colspan="4" class="text-center py-5">
																		<div class="spinner-border text-primary" role="status">
																			<span class="visually-hidden">Loading...</span>
																		</div>
																		<p class="text-muted mt-3 mb-0">Loading content blocks...</p>
																	</td>
																</tr>
															</tbody>
														</table>
													</div>
												</div>
											</div>
										</div>
									</div>
									
								</div>
								
								<!-- SEO Tab -->
								<div class="tab-pane fade" id="seo" role="tabpanel">
									<div class="text-center py-5">
										<i class="align-middle text-muted mb-3" data-feather="search" style="width: 48px; height: 48px;"></i>
										<h5 class="text-muted">SEO Analysis</h5>
										<p class="text-muted">Coming soon - Technical SEO analysis and recommendations</p>
									</div>
								</div>
								
								<!-- JSON Tab -->
								<div class="tab-pane fade" id="json" role="tabpanel">
									<div class="row mb-4">
										<div class="col-12">
											<div class="card border-0" style="border: 1px solid #dee2e6 !important;">
												<div class="card-header bg-white border-bottom">
													<h6 class="card-title mb-0 fw-bold">
														<i class="align-middle text-primary me-2" data-feather="code"></i>
														Raw JSON Data
													</h6>
												</div>
												<div class="card-body">
													<pre id="json-preview" style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px; max-height: 600px; overflow-y: auto;">Loading...</pre>
												</div>
											</div>
										</div>
									</div>
								</div>
								
								<!-- Actions Tab -->
								<div class="tab-pane fade" id="actions" role="tabpanel">
									
									<!-- AI Actions -->
									<div class="row mb-4">
										<div class="col-12">
											<div class="card border-0" style="border: 1px solid #dee2e6 !important;">
												<div class="card-header bg-white border-bottom">
													<h6 class="card-title mb-0 fw-bold">
														<i class="align-middle text-primary me-2" data-feather="cpu"></i>
														AI Processing
													</h6>
												</div>
												<div class="card-body">
													<div class="row">
														<div class="col-md-4 mb-3">
															<button class="btn btn-outline-primary w-100 py-3 border-2" onclick="analyzeContent()">
																<i class="align-middle mb-2" data-feather="search" style="width: 24px; height: 24px;"></i>
																<div class="fw-bold">Analyze Content</div>
																<div class="small text-muted">AI content analysis</div>
															</button>
														</div>
														<div class="col-md-4 mb-3">
															<button class="btn btn-outline-success w-100 py-3 border-2" onclick="optimizeSEO()">
																<i class="align-middle mb-2" data-feather="target" style="width: 24px; height: 24px;"></i>
																<div class="fw-bold">Optimize SEO</div>
																<div class="small text-muted">SEO enhancement</div>
															</button>
														</div>
														<div class="col-md-4 mb-3">
															<button class="btn btn-outline-warning w-100 py-3 border-2" onclick="enhanceHero()">
																<i class="align-middle mb-2" data-feather="star" style="width: 24px; height: 24px;"></i>
																<div class="fw-bold">Enhance Hero</div>
																<div class="small text-muted">Above-fold optimization</div>
															</button>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									
									<!-- Export Options -->
									<div class="row">
										<div class="col-12">
											<div class="card border-0" style="border: 1px solid #dee2e6 !important;">
												<div class="card-header bg-white border-bottom">
													<h6 class="card-title mb-0 fw-bold">
														<i class="align-middle text-secondary me-2" data-feather="download"></i>
														Export & Integration
													</h6>
												</div>
												<div class="card-body">
													<div class="row">
														<div class="col-md-3 mb-2">
															<button class="btn btn-outline-secondary w-100" onclick="viewLive()">
																<i class="align-middle me-2" data-feather="external-link"></i>
																View Live
															</button>
														</div>
														<div class="col-md-3 mb-2">
															<button class="btn btn-outline-secondary w-100" onclick="downloadHTML()">
																<i class="align-middle me-2" data-feather="download"></i>
																Download HTML
															</button>
														</div>
														<div class="col-md-3 mb-2">
															<button class="btn btn-outline-secondary w-100" onclick="copyJSON()">
																<i class="align-middle me-2" data-feather="copy"></i>
																Copy JSON
															</button>
														</div>
														<div class="col-md-3 mb-2">
															<button class="btn btn-outline-secondary w-100" onclick="exportReport()">
																<i class="align-middle me-2" data-feather="file-text"></i>
																Export Report
															</button>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									
								</div>
								
							</div>
						</div>
					</div>
				</div>
				</div>
			</main>
		</div>
	</div>

	<!-- AdminKit Core JS -->
	<script src="/assets/js/adminkit.js"></script>
	
	<!-- Your Custom Framework (UNCHANGED) -->
	<script src="/assets/js/cframework.js"></script>
	<script src="/assets/js/nimbus.js"></script>
	<script>
		// Universal setup (same for all pages)
		document.addEventListener('DOMContentLoaded', async () => {
			cf.init({
				serverUrl: 'https://nimbus-platform.martin-598.workers.dev',
				appName: 'nimbus'
			});
			
			if (!cf.isAuthenticated()) {
				window.location.href = '/auth/login.html';
				return;
			}
			
			// Load user info
			const userName = cf.getUserName();
			const displayName = userName.length > 12 ? userName.substring(0, 12) + '...' : userName;
			document.getElementById('user-name').textContent = displayName;
			
			// Get page ID from hash
			const pageId = window.location.hash.substring(1);
			if (!pageId) {
				window.location.href = '/app/dashboard.html';
				return;
			}
			
			// Load page data
			await loadPageData(pageId);
			await loadNotifications();
		});
		
		function setupBreadcrumb(projectId) {
			// Set up breadcrumb link to go back to project
			document.getElementById('project-breadcrumb-link').href = `/app/project.html#${projectId}`;
		}
		
		async function loadPageData(pageId) {
			try {
				console.log('ðŸ” Loading page data for:', pageId);
				
				// Load page data (framework automatically fetches complete data from KV)
				const page = await nimbus.pages.get(pageId);
				if (!page) throw new Error('Page not found');
				
				console.log('âœ… Page data loaded:', page);
				
				// Update UI
				document.getElementById('page-title').textContent = page.title || 'Untitled';
				
				// Update page type display with icon and text
				const pageType = page.page_type || 'page';
				const priority = getPageTypePriority(pageType);
				const { label, icon } = getPageTypeDisplay(pageType);
				
				// Header display
				document.getElementById('page-type-text').textContent = label;
				document.getElementById('page-type-icon').setAttribute('data-feather', icon);
				
				// Card display
				document.getElementById('page-priority').textContent = priority.toUpperCase();
				document.getElementById('page-type-small').textContent = label;
				
				// Refresh feather icons after updating data-feather attributes
				feather.replace();
				
				// Update header URL
				const baseUrl = 'https://www.repairsbypost.com';
				const liveUrl = page.live_url || `${baseUrl}${page.url}`;
				document.getElementById('page-url-header').textContent = liveUrl;
				
				// Always show "Page" in sidebar to avoid long titles
				document.getElementById('sidebar-page-name').textContent = 'Page';
				
				// Set up breadcrumb navigation
				setupBreadcrumb(page.project_id);
				
				// Update basic page details
				document.getElementById('page-status').textContent = page.status || 'Unknown';
				document.getElementById('page-created').textContent = page.created_at ? cf.formatRelativeTime(page.created_at) : 'Unknown';
				document.getElementById('page-updated').textContent = page.updated_at ? cf.formatRelativeTime(page.updated_at) : 'Unknown';
				document.getElementById('page-url').textContent = page.url || 'No URL';
				
				// Populate enhanced UI with extracted data
				populateEnhancedUI(page);
				
			} catch (error) {
				console.error('âŒ Failed to load page:', error);
				showError(error.message);
			}
		}
		
		function populateEnhancedUI(page) {
			console.log('ðŸŽ¨ Populating enhanced UI with extracted data');
			console.log('ðŸ“Š Page data structure:', page);
			
			// Get extracted data (complete content from KV)
			const extracted = page.extracted_data || {};
			const head = extracted.head || {};
			const blocks = extracted.blocks || [];
			const aboveFold = extracted.above_fold || extracted.above_fold_blocks || [];
			const restOfPage = extracted.rest_of_page || extracted.rest_of_page_blocks || [];
			const dimensions = extracted.dimensions || extracted.content_dimensions || {};
			
			console.log('ðŸ“‹ Extracted data:', {
				hasHead: !!head,
				hasBlocks: blocks.length > 0,
				hasAboveFold: aboveFold.length > 0,
				hasDimensions: Object.keys(dimensions).length > 0,
				headKeys: Object.keys(head),
				blockCount: blocks.length
			});
			
			// Update SERP preview
			updateSERPPreview(page, head);
			
			// Update content stats
			updateContentStats(blocks, aboveFold);
			
			// Update content dimensions
			updateContentDimensions(dimensions);
			
			// Render above-fold content (conditional based on page type)
			renderAboveFoldPreview(aboveFold, page.page_type || 'page');
			
			// Render metadata blocks
			renderMetadataPreview(head);
			
			// Render content blocks table (rest of page only)
			renderContentBlocksTable(restOfPage);
			
			// Render JSON debug view
			renderJSONPreview(page);
			
			console.log('âœ… Enhanced UI populated');
		}
		
		function updateSERPPreview(page, head) {
			const baseUrl = 'https://www.repairsbypost.com';
			const liveUrl = page.live_url || `${baseUrl}${page.url}`;
			
			// Safely update SERP elements
			const urlEl = document.getElementById('serp-url');
			const titleEl = document.getElementById('serp-title');
			const descEl = document.getElementById('serp-description');
			const blocksEl = document.getElementById('serp-blocks');
			
			if (urlEl) urlEl.textContent = liveUrl;
			if (titleEl) titleEl.textContent = head.title || page.title || 'Untitled';
			if (descEl) descEl.textContent = head.metaDescription || head.meta_description || 'No description available';
			if (blocksEl) blocksEl.textContent = `${(page.extracted_data?.blocks || []).length} blocks`;
			
			// Show header image if available (Google SERP style)
			const imageContainer = document.getElementById('serp-image-container');
			const imageEl = document.getElementById('serp-image');
			
			// Priority order: metadata images > above-fold images > any content images
			let headerImage = head.ogImage || head.twitterImage;
			
			// If no metadata image, prioritize above-fold images first
			if (!headerImage || !headerImage.trim()) {
				const aboveFoldBlocks = page.extracted_data?.above_fold_blocks || page.extracted_data?.above_fold || [];
				const aboveFoldImage = aboveFoldBlocks.find(block => block.type === 'img' && block.src);
				headerImage = aboveFoldImage?.src;
			}
			
			// Final fallback: any image from content blocks
			if (!headerImage || !headerImage.trim()) {
				const allBlocks = page.extracted_data?.blocks || [];
				const anyImage = allBlocks.find(block => block.type === 'img' && block.src);
				headerImage = anyImage?.src;
			}
			
			if (headerImage && headerImage.trim()) {
				imageEl.src = headerImage;
				imageContainer.style.display = 'block';
			} else {
				imageContainer.style.display = 'none';
			}
		}
		
		function updateContentStats(blocks, aboveFold) {
			// Count CTAs (links and buttons)
			const ctas = blocks.filter(block => 
				block.type === 'a' || block.type === 'button' || 
				(block.link_type && block.link_type.includes('cta'))
			).length;
			
			// Safely update stat elements
			const totalEl = document.getElementById('total-blocks');
			const aboveFoldEl = document.getElementById('above-fold-blocks');
			const ctaEl = document.getElementById('cta-count');
			const blocksEl = document.getElementById('serp-blocks');
			
			if (totalEl) totalEl.textContent = blocks.length;
			if (aboveFoldEl) aboveFoldEl.textContent = aboveFold.length;
			if (ctaEl) ctaEl.textContent = ctas;
			if (blocksEl) blocksEl.textContent = `${blocks.length} blocks`;
		}
		
		function updateContentDimensions(dimensions) {
			// Safely update elements only if they exist
			const locationEl = document.getElementById('dimension-location');
			const brandEl = document.getElementById('dimension-brand');
			const serviceEl = document.getElementById('dimension-service');
			
			if (locationEl) locationEl.textContent = dimensions.location || 'Not detected';
			if (brandEl) brandEl.textContent = dimensions.brand || 'Not detected';
			if (serviceEl) serviceEl.textContent = dimensions.service || 'Not detected';
		}
		
		// Store above-fold blocks globally for filtering
		let globalAboveFoldBlocks = [];
		
		function renderAboveFoldPreview(aboveFold, pageType = 'page') {
			globalAboveFoldBlocks = aboveFold; // Store for filtering
			const container = document.getElementById('above-fold-preview');
			
			// Check if this is a landing page that should get hero treatment
			const isLandingPage = ['home', 'local_landing', 'brand_landing', 'service_landing', 'product_landing'].includes(pageType);
			
			if (aboveFold.length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<i class="align-middle text-muted mb-3" data-feather="star" style="width: 32px; height: 32px;"></i>
						<h6 class="text-muted">No above-fold content detected</h6>
						<p class="text-muted mb-0">Content extraction may not have identified hero section</p>
					</div>
				`;
				return;
			}
			
			// Render differently based on page type
			if (isLandingPage) {
				renderAboveFoldAsHeroCards(aboveFold, container);
			} else {
				renderAboveFoldAsTable(aboveFold, container);
			}
			
			// Update count
			document.getElementById('above-fold-count').textContent = `(${aboveFold.length})`;
			
			// Set up search listener
			const searchInput = document.getElementById('above-fold-search');
			if (searchInput && !searchInput.hasAttribute('data-listener-added')) {
				searchInput.addEventListener('input', (e) => filterAboveFoldBlocks(e.target.value));
				searchInput.setAttribute('data-listener-added', 'true');
			}
			
			// Initial render
			filterAboveFoldBlocks('');
		}
		
		// Hero card rendering for landing pages
		function renderAboveFoldAsHeroCards(aboveFold, container) {
			const cardsHtml = aboveFold.map(block => {
				const { type, text, anchor, src, alt, href } = block;
				
				let content = '';
				let icon = 'square';
				let badgeColor = 'secondary';
				
				// Determine content and styling based on block type
				if (type === 'h1' || type === 'h2') {
					content = text || 'Untitled';
					icon = 'type';
					badgeColor = 'primary';
				} else if (type === 'p') {
					content = (text || '').substring(0, 120) + (text && text.length > 120 ? '...' : '');
					icon = 'file-text';
					badgeColor = 'info';
				} else if (type === 'img') {
					content = alt || src || 'Image';
					icon = 'image';
					badgeColor = 'success';
				} else if (type === 'a') {
					content = anchor || href || 'Link';
					icon = 'link';
					badgeColor = 'warning';
				} else {
					content = text || anchor || 'Content';
				}
				
				return `
					<div class="col-md-6 col-lg-4 mb-3">
						<div class="card h-100 border-0 shadow-sm">
							<div class="card-body d-flex flex-column">
								<div class="d-flex align-items-center mb-2">
									<span class="badge bg-${badgeColor} me-2">${type.toUpperCase()}</span>
									<i data-feather="${icon}" class="text-muted" style="width: 16px; height: 16px;"></i>
								</div>
								<p class="card-text flex-grow-1">${content}</p>
								${src ? `<small class="text-muted"><i data-feather="link" style="width: 12px; height: 12px;"></i> ${src}</small>` : ''}
								${href ? `<small class="text-warning"><i data-feather="external-link" style="width: 12px; height: 12px;"></i> ${href}</small>` : ''}
							</div>
						</div>
					</div>
				`;
			}).join('');
			
			container.innerHTML = `<div class="row">${cardsHtml}</div>`;
		}
		
		// Table rendering for content pages  
		function renderAboveFoldAsTable(aboveFold, container) {
			const tableRows = aboveFold.map(block => {
				const { type, text, anchor, src, alt, href } = block;
				let content = text || anchor || alt || 'No content';
				let enhancedContent = content;
				
				// Show additional attributes
				if (src) enhancedContent += `<br><small class="text-muted"><i data-feather="link" style="width: 12px; height: 12px;"></i> ${src}</small>`;
				if (href) enhancedContent += `<br><small class="text-warning"><i data-feather="external-link" style="width: 12px; height: 12px;"></i> ${href}</small>`;
				if (alt && type === 'img') enhancedContent += `<br><small class="text-info"><i data-feather="image" style="width: 12px; height: 12px;"></i> Alt: ${alt}</small>`;
				
				// Show inline elements (V2 enhancement)
				if (block.inline_elements && block.inline_elements.length > 0) {
					block.inline_elements.forEach(inline => {
						if (inline.href) {
							enhancedContent += `<br><small class="text-warning"><i data-feather="link-2" style="width: 12px; height: 12px;"></i> Inline: ${inline.href}</small>`;
						}
					});
				}
				
				return `
					<tr>
						<td><span class="badge bg-secondary badge-sm">${type}</span></td>
						<td class="text-wrap" style="max-width: 300px;">${enhancedContent}</td>
						<td><span class="badge bg-primary badge-sm">HIGH</span></td>
					</tr>
				`;
			}).join('');
			
			container.innerHTML = `
				<div class="table-responsive">
					<table class="table table-sm table-hover">
						<thead>
							<tr>
								<th style="width: 80px;">Type</th>
								<th>Content</th>
								<th style="width: 80px;">Priority</th>
							</tr>
						</thead>
						<tbody>${tableRows}</tbody>
					</table>
				</div>
			`;
		}
		
		function filterAboveFoldBlocks(searchTerm) {
			const container = document.getElementById('above-fold-preview');
			const filteredBlocks = globalAboveFoldBlocks.filter(block => {
				const content = (block.text || block.anchor || block.alt || '').toLowerCase();
				const type = (block.type || '').toLowerCase();
				const search = searchTerm.toLowerCase();
				return content.includes(search) || type.includes(search);
			});
			
			if (filteredBlocks.length === 0 && searchTerm) {
				container.innerHTML = `
					<div class="text-center py-4">
						<i class="align-middle text-muted mb-3" data-feather="search" style="width: 32px; height: 32px;"></i>
						<h6 class="text-muted">No matches found</h6>
						<p class="text-muted mb-0">Try a different search term</p>
					</div>
				`;
				document.getElementById('above-fold-count').textContent = `(0 of ${globalAboveFoldBlocks.length})`;
				return;
			}
			
			// Highlight function
			function highlightText(text, searchTerm) {
				if (!searchTerm) return text;
				const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
				return text.replace(regex, '<mark style="background: yellow; padding: 1px 2px;">$1</mark>');
			}
			
			// Render filtered blocks with highlighting
			const preview = filteredBlocks.map(block => {
				const content = block.text || block.anchor || block.alt || 'No content';
				const highlightedContent = highlightText(content, searchTerm);
				
				// Enhanced content display with URLs and attributes
				let enhancedContent = highlightedContent;
				
				// Show img src URLs
				if (block.type === 'img' && block.src) {
					enhancedContent += `<br><small class="text-info"><i data-feather="link" style="width: 12px; height: 12px;"></i> ${block.src}</small>`;
				}
				
				// Show link destinations for a tags
				if (block.type === 'a' && block.href) {
					enhancedContent += `<br><small class="text-success"><i data-feather="external-link" style="width: 12px; height: 12px;"></i> ${block.href}</small>`;
				}
				
				// Show alt text for images
				if (block.alt && block.alt.trim()) {
					enhancedContent += `<br><small class="text-muted"><i data-feather="image" style="width: 12px; height: 12px;"></i> Alt: ${block.alt}</small>`;
				}
				
				// Show title attribute if present
				if (block.title && block.title.trim()) {
					enhancedContent += `<br><small class="text-muted"><i data-feather="info" style="width: 12px; height: 12px;"></i> Title: ${block.title}</small>`;
				}
				
				// Show inline elements (V2 enhancement)
				if (block.inline_elements && block.inline_elements.length > 0) {
					block.inline_elements.forEach(inline => {
						if (inline.href) {
							enhancedContent += `<br><small class="text-warning"><i data-feather="link-2" style="width: 12px; height: 12px;"></i> Inline: ${inline.href}</small>`;
						}
					});
				}
				
				return `
					<div class="mb-3 p-3 bg-white rounded border above-fold-block">
						<div class="d-flex align-items-center mb-2">
							<span class="badge bg-primary me-2">${block.type.toUpperCase()}</span>
							<code class="small text-muted">${block.id}</code>
						</div>
						<div class="fw-medium">${enhancedContent}</div>
					</div>
				`;
			}).join('');
			
			container.innerHTML = `
				<div class="mb-3">
					${preview}
				</div>
			`;
			
			// Update count
			const countText = searchTerm ? 
				`(${filteredBlocks.length} of ${globalAboveFoldBlocks.length})` : 
				`(${globalAboveFoldBlocks.length})`;
			document.getElementById('above-fold-count').textContent = countText;
		}
		
		function renderMetadataPreview(head) {
			const container = document.getElementById('metadata-preview');
			
			if (!head || Object.keys(head).length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<i class="align-middle text-muted mb-3" data-feather="tag" style="width: 32px; height: 32px;"></i>
						<h6 class="text-muted">No metadata found</h6>
						<p class="text-muted mb-0">No head metadata was extracted from this page</p>
					</div>
				`;
				return;
			}
			
			// Define metadata blocks to display
			const metadataBlocks = [
				{ key: 'title', label: 'Page Title', icon: 'type', color: 'primary' },
				{ key: 'metaDescription', label: 'Meta Description', icon: 'file-text', color: 'info' },
				{ key: 'canonical', label: 'Canonical URL', icon: 'link', color: 'success' },
				{ key: 'ogTitle', label: 'Open Graph Title', icon: 'share-2', color: 'warning' },
				{ key: 'ogDescription', label: 'Open Graph Description', icon: 'share-2', color: 'warning' },
				{ key: 'ogImage', label: 'Open Graph Image', icon: 'image', color: 'warning' },
				{ key: 'twitterTitle', label: 'Twitter Title', icon: 'twitter', color: 'info' },
				{ key: 'twitterDescription', label: 'Twitter Description', icon: 'twitter', color: 'info' },
				{ key: 'twitterImage', label: 'Twitter Image', icon: 'image', color: 'info' },
				{ key: 'favicon', label: 'Favicon', icon: 'star', color: 'secondary' }
			];
			
			// Filter to only show blocks with values
			const activeBlocks = metadataBlocks.filter(block => head[block.key] && head[block.key].trim());
			
			if (activeBlocks.length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<i class="align-middle text-muted mb-3" data-feather="tag" style="width: 32px; height: 32px;"></i>
						<h6 class="text-muted">No metadata content</h6>
						<p class="text-muted mb-0">All metadata fields are empty</p>
					</div>
				`;
				return;
			}
			
			// Render metadata blocks
			const blocksHtml = activeBlocks.map(block => {
				const value = head[block.key];
				
				return `
					<div class="metadata-block mb-3 p-3 border rounded" style="background: #f8f9fa;">
						<div class="d-flex align-items-start">
							<div class="me-3">
								<i class="align-middle text-${block.color}" data-feather="${block.icon}" style="width: 20px; height: 20px;"></i>
							</div>
							<div class="flex-grow-1">
								<h6 class="mb-1 fw-bold text-dark">${block.label}</h6>
								<p class="mb-0 text-muted small">${value}</p>
							</div>
						</div>
					</div>
				`;
			}).join('');
			
			container.innerHTML = `
				<div class="mb-3">
					<h6 class="text-muted mb-3">
						<i class="align-middle me-1" data-feather="info" style="width: 16px; height: 16px;"></i>
						Showing ${activeBlocks.length} metadata elements
					</h6>
					${blocksHtml}
				</div>
			`;
		}
		
		// Store content blocks globally for filtering
		let globalContentBlocks = [];
		
		function renderContentBlocksTable(blocks) {
			globalContentBlocks = blocks; // Store for filtering
			const tableBody = document.getElementById('content-blocks-table');
			
			if (blocks.length === 0) {
				tableBody.innerHTML = `
					<tr>
						<td colspan="4" class="text-center py-5">
							<i class="align-middle text-muted mb-3" data-feather="file-text" style="width: 32px; height: 32px;"></i>
							<h6 class="text-muted">No content blocks found</h6>
							<p class="text-muted mb-0">Page may not have been extracted properly</p>
						</td>
					</tr>
				`;
				return;
			}
			
			// Update count and set up filters
			document.getElementById('content-blocks-count').textContent = `(${blocks.length})`;
			
			// Set up filter listeners
			const searchInput = document.getElementById('block-search');
			const typeFilter = document.getElementById('block-filter');
			
			if (searchInput && !searchInput.hasAttribute('data-listener-added')) {
				searchInput.addEventListener('input', (e) => filterContentBlocks());
				searchInput.setAttribute('data-listener-added', 'true');
			}
			
			if (typeFilter && !typeFilter.hasAttribute('data-listener-added')) {
				typeFilter.addEventListener('change', (e) => filterContentBlocks());
				typeFilter.setAttribute('data-listener-added', 'true');
			}
			
			// Initial render
			filterContentBlocks();
			
			// Re-initialize feather icons
			feather.replace();
		}
		
		// Helper functions for page type display
		function getPageTypeDisplay(pageType) {
			const displays = {
				'home': { label: 'Homepage', icon: 'home' },
				'local_landing': { label: 'Local Landing Page', icon: 'map-pin' }, 
				'brand_landing': { label: 'Brand Landing Page', icon: 'tag' },
				'service_landing': { label: 'Service Landing Page', icon: 'tool' },
				'product_landing': { label: 'Product Landing Page', icon: 'shopping-bag' },
				'contact': { label: 'Contact Page', icon: 'phone' },
				'pricing': { label: 'Pricing Page', icon: 'dollar-sign' },
				'about': { label: 'About Page', icon: 'info' },
				'faq': { label: 'FAQ Page', icon: 'help-circle' },
				'legal': { label: 'Legal Page', icon: 'shield' },
				'blog': { label: 'Blog Article', icon: 'edit-3' },
				'index': { label: 'Index Page', icon: 'list' },
				'page': { label: 'Content Page', icon: 'file-text' }
			};
			
			return displays[pageType] || { label: 'Content Page', icon: 'file' };
		}
		
		function getPageTypePriority(pageType) {
			const priorities = {
				'home': 'high',
				'local_landing': 'high', 
				'brand_landing': 'high',
				'service_landing': 'high',
				'product_landing': 'high',
				'contact': 'medium',
				'pricing': 'medium',
				'about': 'low',
				'faq': 'low', 
				'legal': 'low',
				'blog': 'low',
				'index': 'low',
				'page': 'normal'
			};
			return priorities[pageType] || 'normal';
		}
		
		function showError(message) {
			const container = document.querySelector('.tab-content');
			container.innerHTML = `
				<div class="text-center py-5">
					<i class="align-middle text-danger mb-3" data-feather="alert-circle" style="width: 48px; height: 48px;"></i>
					<h5 class="text-danger">Error Loading Page</h5>
					<p class="text-muted">${message}</p>
					<a href="/app/dashboard.html" class="btn btn-primary">Back to Dashboard</a>
				</div>
			`;
			feather.replace();
		}
		
		// Placeholder functions for AI actions
		function analyzeContent() {
			alert('AI Content Analysis - Coming soon!');
		}
		
		function optimizeSEO() {
			alert('SEO Optimization - Coming soon!');
		}
		
		function enhanceHero() {
			alert('Hero Enhancement - Coming soon!');
		}
		
		function viewLive() {
			const url = document.getElementById('serp-url').textContent;
			if (url && url !== 'Loading...') {
				window.open(url, '_blank');
			} else {
				alert('Live URL not available');
			}
		}
		
		function downloadHTML() {
			alert('HTML Download - Coming soon!');
		}
		
		function copyJSON() {
			alert('JSON Export - Coming soon!');
		}
		
		function filterContentBlocks() {
			const tableBody = document.getElementById('content-blocks-table');
			const searchTerm = document.getElementById('block-search')?.value || '';
			const typeFilter = document.getElementById('block-filter')?.value || '';
			
			// Filter blocks
			const filteredBlocks = globalContentBlocks.filter(block => {
				const content = (block.text || block.anchor || block.alt || '').toLowerCase();
				const type = (block.type || '').toLowerCase();
				const search = searchTerm.toLowerCase();
				
				// Type filter
				const typeMatch = !typeFilter || block.type === typeFilter;
				
				// Search filter
				const searchMatch = !searchTerm || content.includes(search) || type.includes(search);
				
				return typeMatch && searchMatch;
			});
			
			if (filteredBlocks.length === 0) {
				tableBody.innerHTML = `
					<tr>
						<td colspan="4" class="text-center py-4">
							<i class="align-middle text-muted mb-3" data-feather="search" style="width: 32px; height: 32px;"></i>
							<h6 class="text-muted">No matches found</h6>
							<p class="text-muted mb-0">Try adjusting your filters</p>
						</td>
					</tr>
				`;
				document.getElementById('content-blocks-count').textContent = `(0 of ${globalContentBlocks.length})`;
				return;
			}
			
			// Highlight function
			function highlightText(text, searchTerm) {
				if (!searchTerm) return text;
				const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
				return text.replace(regex, '<mark style="background: yellow; padding: 1px 2px;">$1</mark>');
			}
			
			// Render filtered blocks with highlighting
			const tableHTML = filteredBlocks.map(block => {
				const content = block.text || block.anchor || block.alt || 'No content';
				const highlightedContent = highlightText(content, searchTerm);
				
				// Enhanced content display with URLs and attributes
				let enhancedContent = highlightedContent;
				
				// Show img src URLs
				if (block.type === 'img' && block.src) {
					enhancedContent += `<br><small class="text-info"><i data-feather="link" style="width: 12px; height: 12px;"></i> ${block.src}</small>`;
				}
				
				// Show link destinations for a tags
				if (block.type === 'a' && block.href) {
					enhancedContent += `<br><small class="text-success"><i data-feather="external-link" style="width: 12px; height: 12px;"></i> ${block.href}</small>`;
				}
				
				// Show alt text for images
				if (block.alt && block.alt.trim()) {
					enhancedContent += `<br><small class="text-muted"><i data-feather="image" style="width: 12px; height: 12px;"></i> Alt: ${block.alt}</small>`;
				}
				
				// Show title attribute if present
				if (block.title && block.title.trim()) {
					enhancedContent += `<br><small class="text-muted"><i data-feather="info" style="width: 12px; height: 12px;"></i> Title: ${block.title}</small>`;
				}
				
				// Show inline elements (V2 enhancement)
				if (block.inline_elements && block.inline_elements.length > 0) {
					block.inline_elements.forEach(inline => {
						if (inline.href) {
							enhancedContent += `<br><small class="text-warning"><i data-feather="link-2" style="width: 12px; height: 12px;"></i> Inline: ${inline.href}</small>`;
						}
					});
				}
				
				return `
					<tr class="content-block-row">
						<td><code class="small">${block.id}</code></td>
						<td><span class="badge bg-primary">${block.type}</span></td>
						<td style="word-wrap: break-word; white-space: normal;">${enhancedContent}</td>
						<td><span class="badge bg-secondary">${block.nimbus_priority || 'normal'}</span></td>
					</tr>
				`;
			}).join('');
			
			tableBody.innerHTML = tableHTML;
			
			// Update count
			const countText = searchTerm || typeFilter ? 
				`(${filteredBlocks.length} of ${globalContentBlocks.length})` : 
				`(${globalContentBlocks.length})`;
			document.getElementById('content-blocks-count').textContent = countText;
		}
		
		function renderJSONPreview(page) {
			const container = document.getElementById('json-preview');
			
			try {
				// Format JSON with proper indentation
				const jsonString = JSON.stringify(page, null, 2);
				container.textContent = jsonString;
			} catch (error) {
				container.textContent = `Error displaying JSON: ${error.message}`;
			}
		}
		
		function exportReport() {
			alert('Report Export - Coming soon!');
		}
		
		function editBlock(blockId) {
			alert(`Edit block: ${blockId} - Coming soon!`);
		}
		
		function aiOptimizeBlock(blockId) {
			alert(`AI optimize block: ${blockId} - Coming soon!`);
		}
		
		function showAllBlocks() {
			alert('Show all blocks - Coming soon!');
		}
		
		function renderLogs(logs) {
			const container = document.getElementById('logs-container');
			
			if (logs.length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<h5>No logs yet</h5>
						<p class="text-muted">Page activity will appear here</p>
					</div>
				`;
				return;
			}
			
			const tableRows = logs.map(log => {
				// Format time in AIVERIE style (HH:MM:SS)
				const time = new Date(log.timestamp || log.created_at);
				const timeStr = time.toLocaleTimeString('en-GB', { 
					hour12: false, 
					hour: '2-digit', 
					minute: '2-digit', 
					second: '2-digit' 
				});
				
				// Truncate user ID like AIVERIE
				const userId = log.user_id || '-';
				const truncatedUserId = userId.length > 15 ? 
					`${userId.substring(0, 8)}...${userId.substring(userId.length - 6)}` : 
					userId;
				
				// Format duration if available
				const duration = log.duration_ms ? 
					`${(log.duration_ms / 1000).toFixed(1)}s` : 
					'';
				
				// Make page ID clickable if it's a page
				const pageId = log.entity_id || '-';
				const pageLink = pageId.startsWith('page:') ? 
					`<a href="/app/page.html#${pageId}" class="text-decoration-none text-primary">${pageId}</a>` : 
					pageId;
				
				// Clean action display
				const actionDisplay = formatActionDisplay(log.action);
				
				return `
					<tr class="log-row" data-log-id="${log.log_id || log.id}" style="cursor: pointer;">
						<td style="font-family: monospace; font-size: 0.9em; color: #6c757d;">${timeStr}</td>
						<td style="font-family: monospace; font-size: 0.9em; color: #6c757d;">${truncatedUserId}</td>
						<td>${actionDisplay}</td>
						<td style="font-family: monospace; font-size: 0.9em; color: #6c757d;">${duration}</td>
						<td>${pageLink}</td>
					</tr>
					<tr class="log-details" data-log-id="${log.log_id || log.id}" style="display: none;">
						<td colspan="5" style="padding: 0; border-top: none;">
							<div class="log-details-content" style="padding: 12px; background-color: #f8f9fa; border-left: 3px solid #007bff;">
								<div class="row">
									<div class="col-md-6">
										<h6 style="margin-bottom: 8px; font-size: 0.9em; color: #495057;">Basic Information</h6>
										<table class="table table-sm table-borderless mb-0" style="font-size: 0.8em;">
											<tr><td style="width: 100px; color: #6c757d;"><strong>Message:</strong></td><td>${log.message || '-'}</td></tr>
											<tr><td style="color: #6c757d;"><strong>User:</strong></td><td style="font-family: monospace;">${log.user_id}</td></tr>
											${log.duration_ms ? `<tr><td style="color: #6c757d;"><strong>Duration:</strong></td><td>${(log.duration_ms / 1000).toFixed(1)}s</td></tr>` : ''}
										</table>
									</div>
									<div class="col-md-6">
										<h6 style="margin-bottom: 8px; font-size: 0.9em; color: #495057;">Technical Details</h6>
										<table class="table table-sm table-borderless mb-0" style="font-size: 0.8em;">
											<tr><td style="width: 100px; color: #6c757d;"><strong>Action:</strong></td><td style="font-family: monospace;">${log.action}</td></tr>
											<tr><td style="color: #6c757d;"><strong>Entity:</strong></td><td style="font-family: monospace;">${log.entity_type}:${log.entity_id}</td></tr>
											<tr><td style="color: #6c757d;"><strong>Level:</strong></td><td><span class="badge bg-${getLogLevelColor(log.level)}">${log.level}</span></td></tr>
										</table>
									</div>
								</div>
								${log.details && Object.keys(log.details).length > 0 ? `
									<div class="mt-2">
										<h6 style="margin-bottom: 6px; font-size: 0.9em; color: #495057;">Additional Details</h6>
										<pre class="mb-0" style="font-size: 0.75em; background-color: #e9ecef; padding: 8px; border-radius: 4px; max-height: 150px; overflow-y: auto;">${JSON.stringify(log.details, null, 2)}</pre>
									</div>
								` : ''}
							</div>
						</td>
					</tr>
				`;
			}).join('');
			
			container.innerHTML = `
				<div class="table-responsive">
					<table class="table table-sm table-hover">
						<thead class="table-light">
							<tr>
								<th style="width: 80px;">Time</th>
								<th style="width: 120px;">User</th>
								<th>Action</th>
								<th style="width: 80px;">Duration</th>
								<th>Page</th>
							</tr>
						</thead>
						<tbody>
							${tableRows}
						</tbody>
					</table>
				</div>
			`;
			
			// Add click handlers for log details
			addLogClickHandlers(logs);
		}
		
		function formatActionDisplay(action) {
			const actionMap = {
				'page_created': 'Page Created',
				'page_updated': 'Page Updated',
				'page_status_updated': 'Status Updated',
				'page_processing_started': 'Processing Started',
				'page_processing_completed': 'Processing Completed',
				'page_processing_failed': 'Processing Failed',
				'page_upload_started': 'Upload Started',
				'page_upload_completed': 'Upload Completed',
				'page_upload_failed': 'Upload Failed',
				'summary_generation_started': 'Summary Generation Started',
				'summary_generation_completed': 'Summary Generation Completed',
				'summary_generation_failed': 'Summary Generation Failed'
			};
			
			return actionMap[action] || action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
		}
		
		function addLogClickHandlers(logs) {
			// Add click handlers for expandable row details
			document.querySelectorAll('.log-row').forEach(row => {
				row.addEventListener('click', function() {
					const logId = this.dataset.logId;
					toggleLogDetails(logId);
				});
			});
		}
		
		function toggleLogDetails(logId) {
			// Find the details row for this log
			const detailsRow = document.querySelector(`tr.log-details[data-log-id="${logId}"]`);
			if (!detailsRow) return;
			
			// Toggle visibility
			if (detailsRow.style.display === 'none') {
				detailsRow.style.display = '';
				// Add smooth animation
				detailsRow.style.opacity = '0';
				detailsRow.style.transition = 'opacity 0.2s ease-in-out';
				setTimeout(() => {
					detailsRow.style.opacity = '1';
				}, 10);
			} else {
				// Smooth fade out
				detailsRow.style.opacity = '0';
				detailsRow.style.transition = 'opacity 0.2s ease-in-out';
				setTimeout(() => {
					detailsRow.style.display = 'none';
				}, 200);
			}
		}
		
		function getLogLevelColor(level) {
			const colors = {
				'info': 'primary',
				'warn': 'warning',
				'error': 'danger',
				'success': 'success'
			};
			return colors[level] || 'secondary';
		}
		
		function getLogBadgeColor(action) {
			const colors = {
				'page_created': 'success',
				'page_updated': 'primary',
				'page_status_processing': 'warning',
				'page_status_completed': 'success',
				'page_deleted': 'danger'
			};
			return colors[action] || 'secondary';
		}
		
		function reloadPage() {
			// Get reload link
			const reloadLink = document.querySelector('[onclick*="reloadPage"]');
			
			// Disable reload link temporarily
			reloadLink.style.pointerEvents = 'none';
			reloadLink.style.opacity = '0.6';
			
			// Show loading state in logs container
			document.getElementById('logs-container').innerHTML = `
				<div class="text-center py-4">
					<div class="spinner-border text-primary"></div>
					<p class="mt-2">Reloading page data...</p>
				</div>
			`;
			
			// Reload page data
			const pageId = window.location.hash.substring(1);
			if (pageId) {
				loadPageData(pageId).then(() => {
					// Re-enable reload link after loading completes
					reloadLink.style.pointerEvents = 'auto';
					reloadLink.style.opacity = '1';
				}).catch(() => {
					// Re-enable reload link even if loading fails
					reloadLink.style.pointerEvents = 'auto';
					reloadLink.style.opacity = '1';
				});
			} else {
				// Re-enable reload link if no page ID
				reloadLink.style.pointerEvents = 'auto';
				reloadLink.style.opacity = '1';
			}
		}
		
		function goBackToProject() {
			// Get the project ID from the current page data or URL
			// For now, go back to dashboard - we'll improve this later
			window.location.href = '/app/dashboard.html';
		}
		
		function editPage() { alert('Edit page coming soon!'); }
		async function handleLogout() { await cf.logout(); window.location.href = '/auth/login.html'; }

		// Smart Notification functions with caching (EXACT copy from dashboard.js)
		async function loadNotifications(forceRefresh = false) {
			console.log(`ðŸ”” Loading notifications...`);
			
			// Use centralized CFramework method
			const result = await cf.loadAndRenderNotifications(forceRefresh);
			
			if (result.success) {
				console.log(`âœ… Notifications loaded: ${result.notifications.length}`);
				
				// Update header with count info
				const header = document.getElementById('notifications-header');
				const unseenCount = result.notifications.filter(n => !n.seen).length;
				const totalCount = result.notifications.length;
				
				if (unseenCount > 0) {
					header.innerHTML = `${unseenCount} New Notification${unseenCount === 1 ? '' : 's'} (${totalCount} total)`;
				} else {
					header.innerHTML = `No new notifications (${totalCount} total)`;
				}
			} else {
				console.error('âŒ Failed to load notifications:', result.error);
			}
		}

		async function markNotificationSeen(notificationId) {
			try {
				console.log('ðŸ”” Marking notification as seen:', notificationId);
				
				// Mark as seen using smart CFramework (auto-updates cache)
				await cf.markNotificationSeen(notificationId);
				
				// Reload notifications to update the UI (will use updated cache)
				await loadNotifications();
				
				console.log('âœ… Notification marked as seen and UI updated');
			} catch (error) {
				console.error('âŒ Error marking notification as seen:', error);
			}
		}

		async function refreshNotificationsOnOpen() {
			// Only refresh if it's been more than 30 seconds since last check
			const timeSinceLastCheck = Date.now() - (cf._notificationCache?.lastFetch || 0);
			const shouldRefresh = timeSinceLastCheck > 30000; // 30 seconds
			
			if (shouldRefresh) {
				console.log('ðŸ”„ Refreshing notifications on dropdown open');
				await loadNotifications(true); // Force refresh
			} else {
				console.log('ðŸ”” Using cached notifications (recent)');
			}
		}
	</script>

</body>
</html>
