<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="NimbusAI - Content Optimization Platform">
	<meta name="author" content="NimbusAI">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="/assets/img/icons/icon-48x48.png" />

	<title>Project Dashboard - NimbusHQ</title>

	<link href="/assets/css/app.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
	
	<!-- uPlot for clean sparklines -->
	<script src="https://unpkg.com/uplot/dist/uPlot.iife.min.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/uplot/dist/uPlot.min.css" />
	
	<!-- uPlot Sparkline Styles -->
	<style>
		.sparkline-container {
			height: 90px;
			margin-top: 0;
			position: relative;
			width: 100%;
			overflow: hidden;
		}
		
		.sparkline-container .u-plot {
			width: 100% !important;
		}
		
		.card-body {
			padding: 0; /* Remove all padding from parent card */
		}
		
		.card-content-wrapper {
			padding: 1.25rem 1.25rem 0 1.25rem; /* Add padding back to stats wrapper */
		}
		
		.sparkline-container {
			margin-bottom: 0; /* No bottom margin */
		}
		
		/* Compact table styles */
		.table-sm td, .table-sm th {
			padding: 0.375rem 0.5rem;
			font-size: 0.875rem;
		}
		
		.badge-sm {
			font-size: 0.75rem;
			padding: 0.25em 0.5em;
		}
		
		/* Responsive column sizing with truncation */
		.table-responsive .col-title {
			min-width: 200px;
			max-width: 250px;
		}
		
		.table-responsive .col-url {
			min-width: 150px;
			max-width: 200px;
		}
		
		.table-responsive .col-type {
			min-width: 100px;
			max-width: 120px;
		}
		
		.table-responsive .col-status {
			min-width: 80px;
			max-width: 100px;
		}
		
		.table-responsive .col-activity {
			min-width: 100px;
			max-width: 120px;
		}
		
		.text-truncate {
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
	</style>
	
	<!-- Bootstrap 5 Breadcrumb Styles -->
	<style>
		.breadcrumb {
			display: flex;
			flex-wrap: wrap;
			padding: 0;
			margin-bottom: 1rem;
			list-style: none;
		}
		
		.breadcrumb-item {
			display: flex;
		}
		
		.breadcrumb-item + .breadcrumb-item {
			padding-left: 0.5rem;
		}
		
		.breadcrumb-item + .breadcrumb-item::before {
			display: inline-block;
			padding-right: 0.5rem;
			color: #6c757d;
			content: "/";
		}
		
		.breadcrumb-item > a {
			color: #0d6efd;
			text-decoration: none;
		}
		
		.breadcrumb-item > a:hover {
			color: #0a58ca;
			text-decoration: underline;
		}
		
		.breadcrumb-item.active {
			color: #6c757d;
		}
	</style>
</head>

<body>
	<div class="wrapper">
		<!-- Sidebar Navigation -->
		<nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="/app/dashboard.html">
					<span class="align-middle">NimbusHQ</span>
				</a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						Main
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/dashboard.html">
							<i class="align-middle" data-feather="home"></i> <span class="align-middle">Account Home</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="#" id="project-link">
							<i class="align-middle" data-feather="folder"></i> <span class="align-middle" id="sidebar-project-name">Project</span>
						</a>
					</li>

					<!-- Project Sub-Navigation -->
					<li class="sidebar-item active">
						<a class="sidebar-link" href="#">
							<i class="align-middle" data-feather="grid"></i> <span class="align-middle">Dashboard</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="#" id="project-activity-link">
							<i class="align-middle" data-feather="activity"></i> <span class="align-middle">Activity</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="#" id="project-analytics-link">
							<i class="align-middle" data-feather="bar-chart-2"></i> <span class="align-middle">Analytics</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="#" id="project-settings-link">
							<i class="align-middle" data-feather="settings"></i> <span class="align-middle">Settings</span>
						</a>
					</li>

					<li class="sidebar-header">
						Account
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/notifications.html">
							<i class="align-middle" data-feather="bell"></i> <span class="align-middle">Notifications</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/settings.html">
							<i class="align-middle" data-feather="settings"></i> <span class="align-middle">Settings</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="/app/profile.html">
							<i class="align-middle" data-feather="user"></i> <span class="align-middle">Profile</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>

		<!-- Main Content -->
		<div class="main">
			<!-- Top Navigation Bar -->
			<nav class="navbar navbar-expand navbar-light navbar-bg">
				<a class="sidebar-toggle js-sidebar-toggle">
					<i class="hamburger align-self-center"></i>
				</a>

				<div class="navbar-collapse collapse">
					<ul class="navbar-nav navbar-align">
						<!-- Notifications -->
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle" href="#" id="alertsDropdown" data-bs-toggle="dropdown" onclick="refreshNotificationsOnOpen()">
								<div class="position-relative">
									<i class="align-middle" data-feather="bell"></i>
									<span class="indicator" id="notification-count" style="display: none;">0</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0" aria-labelledby="alertsDropdown">
								<div class="dropdown-menu-header" id="notifications-header">
									<div class="spinner-border spinner-border-sm" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
									Loading notifications...
								</div>
								<div class="list-group" id="notifications-list">
									<!-- Notifications will be loaded here -->
								</div>
								<div class="dropdown-menu-footer">
									<a href="/app/notifications.html" class="text-muted">Show all notifications</a>
								</div>
							</div>
						</li>

						<!-- User Menu -->
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
								<i class="align-middle" data-feather="settings"></i>
							</a>

							<a class="nav-link d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
								<div class="d-flex align-items-center">
									<div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; flex-shrink: 0;">
										<i data-feather="user" style="width: 16px; height: 16px;"></i>
									</div>
									<span class="text-dark dropdown-toggle" id="user-name">Loading...</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-end" style="min-width: 250px;">
								<a class="dropdown-item" href="/app/profile.html"><i class="align-middle me-1" data-feather="user"></i> Profile</a>
								<a class="dropdown-item" href="/app/settings.html"><i class="align-middle me-1" data-feather="settings"></i> Settings</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="#" onclick="handleLogout()"><i class="align-middle me-1" data-feather="log-out"></i> Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

			<!-- Page Content -->
			<main class="content">
				<div class="container-fluid p-0">
					<!-- Breadcrumb Navigation -->
					<nav aria-label="breadcrumb" class="pt-3 pb-2">
						<ol class="breadcrumb mb-0">
							<li class="breadcrumb-item"><a href="/app/dashboard.html">Account Home</a></li>
							<li class="breadcrumb-item active" aria-current="page">Project</li>
						</ol>
					</nav>

					<!-- Page Header -->
					<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-2 mb-3">
						<div>
							<div style="font-size: 16px; line-height: 1.5; color: black; font-weight: 600; margin-bottom: 8px;">Project home</div>
							<h1 class="h2" id="project-title">Loading...</h1>
						</div>
						<div class="btn-toolbar mb-2 mb-md-0">
							<button type="button" class="btn btn-primary" onclick="uploadPages()">
								<i data-feather="upload"></i> Upload Pages
							</button>
						</div>
					</div>

					<!-- Stats Row with Mini Charts -->
					<div class="row mb-4">
						<div class="col-md-4">
							<div class="card">
								<div class="card-body text-center">
					<div class="card-content-wrapper">
						<div class="row">
							<div class="col mt-0">
								<h5 class="card-title">Pages</h5>
							</div>
							<div class="col-auto">
								<div class="stat text-primary">
									<i class="align-middle" data-feather="file-text"></i>
								</div>
							</div>
						</div>
						<h1 class="mt-1 mb-2" id="total-pages-count">-</h1>
					</div>
					<!-- Mini Sparkline Chart -->
					<div id="pages-chart" class="sparkline-container"></div>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card">
								<div class="card-body text-center">
					<div class="card-content-wrapper">
						<div class="row">
							<div class="col mt-0">
								<h5 class="card-title">Complete</h5>
							</div>
							<div class="col-auto">
								<div class="stat text-success">
									<i class="align-middle" data-feather="check-circle"></i>
								</div>
							</div>
						</div>
						<h1 class="mt-1 mb-2" id="complete-pages-count">-</h1>
					</div>
					<!-- Mini Sparkline Chart -->
					<div id="complete-chart" class="sparkline-container"></div>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card">
								<div class="card-body text-center">
					<div class="card-content-wrapper">
						<div class="row">
							<div class="col mt-0">
								<h5 class="card-title">Processing</h5>
							</div>
							<div class="col-auto">
								<div class="stat text-warning">
									<i class="align-middle" data-feather="clock"></i>
								</div>
							</div>
						</div>
						<h1 class="mt-1 mb-2" id="processing-count">-</h1>
					</div>
					<!-- Mini Sparkline Chart -->
					<div id="processing-chart" class="sparkline-container"></div>
								</div>
							</div>
						</div>
					</div>

					<!-- Projects Table (Cloudflare Style) -->
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header d-flex justify-content-between align-items-center">
									<h5 class="card-title mb-0">Pages</h5>
									<a href="#" onclick="reloadProject(); return false;" class="text-muted text-decoration-none" style="font-size: 14px;">
										<i data-feather="refresh-cw" style="width: 14px; height: 14px;"></i> Reload
									</a>
								</div>
								<div class="card-body">
									<div id="pages-container">
										<div class="loading text-center py-4">
											<div class="spinner-border text-primary"></div>
											<p class="mt-2">Loading projects...</p>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>

	<!-- AdminKit Core JS -->
	<script src="/assets/js/adminkit.js"></script>
	
	<!-- Your Custom Framework (UNCHANGED) -->
	<script src="/assets/js/cframework.js"></script>
	<script src="/assets/js/chart-framework.js"></script>
	<script src="/assets/js/nimbus.js"></script>
	<script>
		// Universal setup (same for all pages)
		document.addEventListener('DOMContentLoaded', async () => {
			cf.init({
				serverUrl: 'https://nimbus-platform.martin-598.workers.dev',
				appName: 'nimbus'
			});
			
			if (!cf.isAuthenticated()) {
				window.location.href = '/auth/login.html';
				return;
			}
			
			// Load user info
			const userName = cf.getUserName();
			const displayName = userName.length > 12 ? userName.substring(0, 12) + '...' : userName;
			document.getElementById('user-name').textContent = displayName;
			
			// Get project ID from hash
			const projectId = window.location.hash.substring(1);
			if (!projectId) {
				window.location.href = '/app/dashboard.html';
				return;
			}
			
			// Set up navigation links
			setupNavigation(projectId);
			
			// Load project data
			await loadProjectData(projectId);
			await loadNotifications();
		});
		
		function setupNavigation(projectId) {
			// Set up project navigation links
			document.getElementById('project-link').href = `/app/project.html#${projectId}`;
			document.getElementById('project-activity-link').href = `/app/project/activity.html#${projectId}`;
			document.getElementById('project-analytics-link').href = `/app/project/analytics.html#${projectId}`;
			document.getElementById('project-settings-link').href = `/app/project/settings.html#${projectId}`;
		}
		
		async function loadProjectData(projectId) {
			try {
				// Load project with stats (optimized - single API call)
				const project = await nimbus.projects.get(projectId);
				if (!project) throw new Error('Project not found');
				
				// Update UI
				document.getElementById('project-title').textContent = `${project.name}'s dashboard:`;
				document.getElementById('sidebar-project-name').textContent = project.name;
				
				// Parse project stats (comes as JSON string from D1)
				let stats = { total_pages: 0, processing_pages: 0, completed_pages: 0 };
				if (project.stats) {
					if (typeof project.stats === 'string') {
						try {
							stats = JSON.parse(project.stats);
						} catch (e) {
							console.warn('Failed to parse project stats:', e);
						}
					} else if (typeof project.stats === 'object') {
						stats = project.stats;
					}
				}
				
				// Update stats from project data (fast!)
				document.getElementById('total-pages-count').textContent = stats.total_pages;
				document.getElementById('complete-pages-count').textContent = stats.completed_pages;
				document.getElementById('processing-count').textContent = stats.processing_pages;
				
				// Load analytics charts
				await loadProjectCharts(projectId);
				
				// Load pages for the table (only if we have pages)
				if (stats.total_pages > 0) {
					const pages = await nimbus.pages.list(projectId, { limit: 200 });
					renderPages(pages);
				} else {
					renderPages([]);
				}
				
			} catch (error) {
				console.error('Failed to load project:', error);
				document.getElementById('pages-container').innerHTML = `
					<div class="alert alert-danger">
						<h5>Error Loading Project</h5>
						<p>${error.message}</p>
						<a href="/app/dashboard.html" class="btn btn-primary">Back to Dashboard</a>
					</div>
				`;
			}
		}
		
		function renderPages(pages) {
			const container = document.getElementById('pages-container');
			
			if (pages.length === 0) {
				container.innerHTML = `
					<div class="text-center py-4">
						<h5>No pages yet</h5>
						<p class="text-muted">Upload pages to get started</p>
						<button class="btn btn-primary" onclick="uploadPages()">Upload Pages</button>
					</div>
				`;
				return;
			}
			
			const tableRows = pages.map(page => {
				// Use actual detected page type from backend, with fallback
				const pageType = page.page_type || 'page';
				const priority = getPageTypePriority(pageType);
				
				// Get display label for page type
				const typeLabel = getPageTypeDisplayLabel(pageType);
				
				return `
					<tr onclick="viewPage('${page.page_id}')" style="cursor: pointer;">
						<td class="col-title"><span class="text-truncate d-inline-block" style="max-width: 100%;">${page.title || 'Untitled'}</span></td>
						<td class="col-url"><span class="text-truncate d-inline-block text-muted" style="max-width: 100%;" title="${page.url || '-'}">${page.url || '-'}</span></td>
						<td class="col-type"><span class="badge bg-info badge-sm">${typeLabel}</span></td>
						<td class="col-priority"><span class="badge bg-${getPriorityBadgeColor(priority)} badge-sm">${priority.toUpperCase()}</span></td>
						<td class="col-activity text-muted">${page.updated_at ? cf.formatRelativeTime(page.updated_at) : 'Never'}</td>
					</tr>
				`;
			}).join('');
			
			container.innerHTML = `
				<div class="table-responsive">
					<table class="table table-hover table-sm">
						<thead>
							<tr>
								<th class="col-title">Title</th>
								<th class="col-url">URL</th>
								<th class="col-type">Type</th>
								<th class="col-priority">Priority</th>
								<th class="col-activity">Last Activity</th>
							</tr>
						</thead>
						<tbody>${tableRows}</tbody>
					</table>
				</div>
			`;
		}
		
		function reloadProject() {
			// Get reload link
			const reloadLink = document.querySelector('[onclick*="reloadProject"]');
			
			// Disable reload link temporarily
			reloadLink.style.pointerEvents = 'none';
			reloadLink.style.opacity = '0.6';
			
			// Show loading state in pages container
			document.getElementById('pages-container').innerHTML = `
				<div class="text-center py-4">
					<div class="spinner-border text-primary"></div>
					<p class="mt-2">Reloading project data...</p>
				</div>
			`;
			
			// Reset stats to loading state
			document.getElementById('total-pages-count').textContent = '-';
			document.getElementById('complete-pages-count').textContent = '-';
			document.getElementById('processing-count').textContent = '-';
			
			// Reload project data
			const projectId = window.location.hash.substring(1);
			if (projectId) {
				loadProjectData(projectId).then(() => {
					// Re-enable reload link after loading completes
					reloadLink.style.pointerEvents = 'auto';
					reloadLink.style.opacity = '1';
				}).catch(() => {
					// Re-enable reload link even if loading fails
					reloadLink.style.pointerEvents = 'auto';
					reloadLink.style.opacity = '1';
				});
			} else {
				// Re-enable reload link if no project ID
				reloadLink.style.pointerEvents = 'auto';
				reloadLink.style.opacity = '1';
			}
		}
		
		// Store chart instances for resize handling
		let chartInstances = {};

		// Debounce utility function
		function debounce(func, wait) {
			let timeout;
			return function executedFunction(...args) {
				const later = () => {
					clearTimeout(timeout);
					func(...args);
				};
				clearTimeout(timeout);
				timeout = setTimeout(later, wait);
			};
		}

		// Load analytics charts for project dashboard using CloudFunctions
		async function loadProjectCharts(projectId) {
			try {
				console.log('üìä Loading project analytics charts via CloudFunctions...');
				
				let baseActivity, completeActivity, processingActivity;
				
				// Use proper CloudFunction approach - no direct SQL calls
				console.log('üìä Using analytics.metrics CloudFunction...');
				
				// Get metrics using NEW CLEAN ANALYTICS STRUCTURE
				// blob1=entity, blob2=action, blob3=project_id, blob4=status
				const [allPagesResult, completedResult, processingResult] = await Promise.all([
					cf.run('analytics.metrics', {
						category: 'page',           // blob1: entity type
						project_id: projectId,     // blob3: clean project_id
						timeRange: '24h',
						action: 'uploaded'         // Pages sparkline should reflect new pages added only
					}),
					cf.run('analytics.metrics', {
						category: 'page', 
						project_id: projectId,
						timeRange: '24h',
						action: 'completed'         // blob2: only completed actions
					}),
					cf.run('analytics.metrics', {
						category: 'page',
						project_id: projectId, 
						timeRange: '24h',
						status: 'processing'        // blob4: only processing status
					})
				]);
				
				console.log('üìä CloudFunction results (RAW):', {
					pages: allPagesResult,
					completed: completedResult,
					processing: processingResult
				});
				
				// Extract chart data from CloudFunction responses (result.data.data.datasets[0].data)
				const extractSeries = (res) => Array.isArray(res?.data?.data?.datasets?.[0]?.data)
					? res.data.data.datasets[0].data
					: Array(24).fill(0);
				
				baseActivity = extractSeries(allPagesResult);
				completeActivity = extractSeries(completedResult);
				processingActivity = extractSeries(processingResult);
				
				console.log('üìä Extracted chart arrays:', {
					baseActivity,
					completeActivity, 
					processingActivity
				});
				
				// Debug: Show actual values
				console.log('üîç Data inspection:');
				console.log('  Pages data:', baseActivity.slice(0, 5), '...', baseActivity.slice(-3));
				console.log('  Complete data:', completeActivity.slice(0, 5), '...', completeActivity.slice(-3));
				console.log('  Processing data:', processingActivity.slice(0, 5), '...', processingActivity.slice(-3));
				
				// Create sparklines using uPlot (your exact working configuration)
				const createuPlotSparkline = (containerId, data, color, yMax) => {
					const container = document.getElementById(containerId);
					if (!container) return;
					
					console.log(`üé® Creating uPlot sparkline for ${containerId} with data:`, data);
					
					// Clear container and destroy existing chart
					container.innerHTML = '';
					if (chartInstances[containerId]) {
						chartInstances[containerId].destroy();
					}
					
					// Prepare data for uPlot [x, y] format
					const plotData = [
						data.map((_, i) => i), // x values: [0,1,2,3,4,...]
						data // y values: our activity data
					];
					
					// Store chart instance for resize handling
					chartInstances[containerId] = new uPlot({
						width: container.offsetWidth, // Full width, no padding
						height: 80,
						padding: [8, 0, 8, 0], // top, right, bottom, left padding (no side padding)
						scales: {
							x: { time: false },
							y: {
								range: [0, Math.max(1, yMax || 1)]
							}
						},
						series: [
							{}, // x values
							{ 
								stroke: color, 
								width: 1, 
								fill: false,
								points: { show: false }, // Remove circles
								spline: true // Add curved lines
							}
						],
						axes: [
							{ show: false }, // x axis hidden
							{ show: false }  // y axis hidden
						],
						legend: { show: false },
						cursor: { show: false },
						select: { show: false }
					}, plotData, container);
					
					console.log(`‚úÖ uPlot sparkline created: ${containerId}`);
				};
				
				// "No data" UI helper
				const showNoData = (containerId) => {
					const container = document.getElementById(containerId);
					if (!container) return;
					container.innerHTML = `
						<div class="text-center text-muted p-2">
							<small>No data</small>
						</div>
					`;
				};
				
				// Compute shared Y max across series for proportional scaling
				const sharedMax = Math.max(
					...(baseActivity || [0]),
					...(completeActivity || [0]),
					...(processingActivity || [0])
				);
				const yMax = Math.max(1, sharedMax);
				
				// Render or show no-data per series
				const isAllZero = (arr) => Array.isArray(arr) && arr.every(v => (Number(v) || 0) === 0);
				
				createuPlotSparkline('pages-chart', baseActivity, '#007bff', yMax);
				createuPlotSparkline('complete-chart', completeActivity, '#28a745', yMax);
				createuPlotSparkline('processing-chart', processingActivity, '#ffc107', yMax);
				
				console.log('‚úÖ Project charts loaded with custom SVG sparklines');
				
				// Add resize event listener to redraw charts with immediate response
				let resizeTimeout;
				window.addEventListener('resize', () => {
					// Immediate resize to prevent overflow
					Object.keys(chartInstances).forEach(containerId => {
						const chart = chartInstances[containerId];
						if (chart) {
							const container = document.getElementById(containerId);
							if (container) {
								chart.setSize({
									width: container.offsetWidth,
									height: 80
								});
							}
						}
					});
					
					// Debounced final resize for performance
					clearTimeout(resizeTimeout);
					resizeTimeout = setTimeout(() => {
						console.log('üì± Final resize optimization...');
						Object.keys(chartInstances).forEach(containerId => {
							const chart = chartInstances[containerId];
							if (chart) {
								const container = document.getElementById(containerId);
								if (container) {
									chart.setSize({
										width: container.offsetWidth,
										height: 80
									});
								}
							}
						});
					}, 100);
				});
				
			} catch (error) {
				console.error('Failed to load project charts:', error);
				// Show no data on all charts if request fails
				const showNoData = (containerId) => {
					const container = document.getElementById(containerId);
					if (!container) return;
					container.innerHTML = `
						<div class="text-center text-muted p-2">
							<small>No data</small>
						</div>
					`;
				};
				showNoData('pages-chart');
				showNoData('complete-chart');
				showNoData('processing-chart');
			}
		}

		function uploadPages() { alert('Upload pages coming soon!'); }
		function viewPage(pageId) { 
			// Navigate to page view using hash (works with any server)
			window.location.href = `/app/page.html#${pageId}`;
		}
		async function handleLogout() { await cf.logout(); window.location.href = '/auth/login.html'; }

		// Smart Notification functions with caching (EXACT copy from dashboard.js)
		async function loadNotifications(forceRefresh = false) {
			console.log(`üîî Loading notifications...`);
			
			// Use centralized CFramework method
			const result = await cf.loadAndRenderNotifications(forceRefresh);
			
			if (result.success) {
				console.log(`‚úÖ Notifications loaded: ${result.notifications.length}`);
				
				// Update header with count info
				const header = document.getElementById('notifications-header');
				const unseenCount = result.notifications.filter(n => !n.seen).length;
				const totalCount = result.notifications.length;
				
				if (unseenCount > 0) {
					header.innerHTML = `${unseenCount} New Notification${unseenCount === 1 ? '' : 's'} (${totalCount} total)`;
				} else {
					header.innerHTML = `No new notifications (${totalCount} total)`;
				}
			} else {
				console.error('‚ùå Failed to load notifications:', result.error);
			}
		}

		function renderNotifications(notifications) {
			const container = document.getElementById('notifications-list');
			
			if (notifications.length === 0) {
				container.innerHTML = `
					<div class="list-group-item text-center py-3">
						<div class="text-muted">No notifications yet</div>
						<small class="text-muted">You'll see updates here when things happen</small>
					</div>
				`;
				return;
			}

			container.innerHTML = notifications.map(notification => {
				const timeAgo = formatTimeAgo(notification.created_at);
				const iconClass = getNotificationIcon(notification.type);
				const isUnread = !notification.seen;
				
				return `
					<div class="list-group-item ${isUnread ? 'bg-light' : ''}" style="cursor: pointer;" onclick="markNotificationSeen('${notification.notification_id}')">
						<div class="row g-0 align-items-center">
							<div class="col-2">
								<i class="${iconClass}" data-feather="bell"></i>
							</div>
							<div class="col-10">
								<div class="text-dark fw-bold">${notification.title || 'Notification'}</div>
								<div class="text-muted small mt-1">${notification.message}</div>
								<div class="text-muted small">${timeAgo}</div>
							</div>
						</div>
					</div>
				`;
			}).join('');

			// Re-initialize feather icons
			if (typeof feather !== 'undefined') {
				feather.replace();
			}
		}

		function showNotificationError() {
			const header = document.getElementById('notifications-header');
			const container = document.getElementById('notifications-list');
			
			header.innerHTML = 'Error loading notifications';
			container.innerHTML = `
				<div class="list-group-item text-center py-3">
					<div class="text-danger">Failed to load notifications</div>
					<small class="text-muted">Please try refreshing the page</small>
				</div>
			`;
		}

		async function markNotificationSeen(notificationId) {
			try {
				console.log('üîî Marking notification as seen:', notificationId);
				
				// Mark as seen using smart CFramework (auto-updates cache)
				await cf.markNotificationSeen(notificationId);
				
				// Reload notifications to update the UI (will use updated cache)
				await loadNotifications();
				
				console.log('‚úÖ Notification marked as seen and UI updated');
			} catch (error) {
				console.error('‚ùå Error marking notification as seen:', error);
			}
		}

		async function refreshNotificationsOnOpen() {
			// Only refresh if it's been more than 30 seconds since last check
			const timeSinceLastCheck = Date.now() - (cf._notificationCache?.lastFetch || 0);
			const shouldRefresh = timeSinceLastCheck > 30000; // 30 seconds
			
			if (shouldRefresh) {
				console.log('üîÑ Refreshing notifications on dropdown open');
				await loadNotifications(true); // Force refresh
			} else {
				console.log('üîî Using cached notifications (recent)');
			}
		}

		function updateNotificationCount(notifications) {
			const countElement = document.getElementById('notification-count');
			const unreadCount = notifications.filter(n => !n.seen).length;
			
			if (unreadCount > 0) {
				countElement.textContent = unreadCount;
				countElement.style.display = 'block';
			} else {
				countElement.style.display = 'none';
			}
		}

		function formatTimeAgo(timestamp) {
			const now = new Date();
			const time = new Date(timestamp);
			const diffMs = now - time;
			const diffMins = Math.floor(diffMs / 60000);
			const diffHours = Math.floor(diffMs / 3600000);
			const diffDays = Math.floor(diffMs / 86400000);

			if (diffMins < 1) return 'Just now';
			if (diffMins < 60) return `${diffMins}m ago`;
			if (diffHours < 24) return `${diffHours}h ago`;
			return `${diffDays}d ago`;
		}

		function getNotificationIcon(type) {
			const icons = {
				success: 'text-success',
				error: 'text-danger',
				warning: 'text-warning',
				info: 'text-info'
			};
			return icons[type] || 'text-primary';
		}
		
		// Helper functions for page type display in project table
		function getPageTypeDisplayLabel(pageType) {
			const labels = {
				'home': 'Home',
				'local_landing': 'Local',
				'brand_landing': 'Brand',
				'service_landing': 'Service',
				'product_landing': 'Product',
				'contact': 'Contact',
				'pricing': 'Pricing',
				'about': 'About',
				'faq': 'FAQ',
				'legal': 'Legal',
				'blog': 'Article',
				'index': 'Index',
				'page': 'Page'
			};
			return labels[pageType] || 'Page';
		}
		
		function getPageTypePriority(pageType) {
			const priorities = {
				'home': 'high',
				'local_landing': 'high',
				'brand_landing': 'high',
				'service_landing': 'high',
				'product_landing': 'high',
				'contact': 'medium',
				'pricing': 'medium',
				'about': 'low',
				'faq': 'low',
				'legal': 'low',
				'blog': 'low',
				'index': 'low',
				'page': 'normal'
			};
			return priorities[pageType] || 'normal';
		}
		
		function getPriorityBadgeColor(priority) {
			const colors = {
				'high': 'danger',
				'medium': 'warning',
				'low': 'secondary',
				'normal': 'secondary'
			};
			return colors[priority] || 'secondary';
		}
	</script>

</body>
</html>
