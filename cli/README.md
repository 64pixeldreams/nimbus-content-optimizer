# Nimbus CLI

Simple local interface to sync a website with the Nimbus CloudFunctions Worker.

## Install

- Local (already in repo):
```bash
node cli/bin/nimbus.js --help
```
- Optional global link (developer convenience):
```bash
cd cli && npm i && npm link
nimbus --help
```

## Commands

### 1) Set API key
```bash
nimbus set-api-key <API_KEY> --api-url https://nimbus-platform.martin-598.workers.dev
```
Stores and validates the API key. Required once per machine.

### 2) Create or link project, optionally extract, then upload maps
```bash
# Create new project and upload
nimbus sync-project --name "Watch Repair Site" --domain www.repairsbypost.com --extract --folder dist/local

# Or link an existing project and upload
nimbus sync-project --link project:mfk84u22pgj849 --extract --folder dist

# Upload without running extraction (maps pre-generated by Gulp)
nimbus sync-project --link project:mfk84u22pgj849 --maps-dir gulp/.nimbus/maps --concurrency 6
```
- `--extract`: invokes the existing Gulp extraction task; no code is duplicated.
- `--folder`: folder to scan (same as your current Gulp usage).
- `--maps-dir`: where JSON maps are read from (defaults to `gulp/.nimbus/maps`).

### 3) Upload pages from maps (one or many)
```bash
nimbus upsert-pages --maps-dir gulp/.nimbus/maps --concurrency 6
```
Reads `gulp/.nimbus/maps/*.json` and uploads via `page.upsert`. Uses retry/backoff for transient errors.

### 4) Pull changes (optional)
```bash
nimbus pull-changes
```
Fetches remote updates and refreshes `.nimbus/pages.json` (stub – implement when needed).

### 5) Status (optional)
```bash
nimbus status
```
Shows linked project and last sync info (stub – implement when needed).

## How it Works
- Gulp remains the single source-of-truth for extraction. The CLI never re-implements extraction.
- The CLI calls CloudFunctions over a single endpoint:
  - `project.create`, `project.get`
  - `page.upsert`
- Local state:
  - `.nimbus/project.json` – authoritative `project_id` source
  - `.nimbus/pages.json` – upload results and sync metadata

## Tips
- Use `--concurrency` to tune throughput (default 5).
- If you see 429s, the CLI auto-retries with exponential backoff.
- To upload a sub-set, generate maps for the files you want and point `--maps-dir` to that folder.
